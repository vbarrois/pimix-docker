!function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=3)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScannerCommand=t.ClientCommand=t.ServerCommand=t.ClientType=void 0,function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.PIMIXPLAYER=1]="PIMIXPLAYER",e[e.MIXER=2]="MIXER",e[e.PLAYER=3]="PLAYER",e[e.PLAYLIST=4]="PLAYLIST",e[e.TOASTER=5]="TOASTER",e[e.SEARCH=6]="SEARCH",e[e.SCANNER=7]="SCANNER"}(t.ClientType||(t.ClientType={})),function(e){e.MAP="map",e.COMMAND="command",e.PLAYERINIT="player_init",e.TRACK="track",e.MIXER="mixer",e.PLAYLISTADD="playlist_add",e.MESSAGE="message",e.VOTE="vote"}(t.ServerCommand||(t.ServerCommand={})),function(e){e.SERVERLIST="serverlist",e.SCANNER="scanner",e.PLAYPAUSE="play",e.NEXT="next",e.ATTACHED="attached",e.DETACHED="detached",e.MIXER="mixer",e.USERS="users",e.PLAYLISTINIT="playlist_init",e.PLAYLISTADD="playlist_add",e.PLAYLISTINDEX="playlist_index",e.MESSAGE="message",e.VOTESINIT="votes_init",e.VOTE="vote",e.TRACK="track"}(t.ClientCommand||(t.ClientCommand={})),function(e){e.UPDATE="update"}(t.ScannerCommand||(t.ScannerCommand={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;t.Client=class{constructor(e){this.sd=e,this.sd.socket.on("disconnect",()=>{this.sd.router.ondisconnect(this.sd)})}get id(){return this.sd.id}isConcerned(e){return this.sd.type===e}}},function(e,t){e.exports=require("hashmap")},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(4)),r=s(i(5)),o=i(6),a=i(14);console.clear(),console.log("__________.__   _____  .__         __________               __                "),console.log("\\______   \\__| /     \\ |__|__  ___ \\______   \\ ____  __ ___/  |_  ___________ "),console.log(" |     ___/  |/  \\ /  \\|  \\  \\/  /  |       _//  _ \\|  |  \\   __\\/ __ \\_  __ \\"),console.log(" |    |   |  /    Y    \\  |>    <   |    |   (  <_> )  |  /|  | \\  ___/|  | \\/"),console.log(" |____|   |__\\____|__  /__/__/\\_ \\  |____|_  /\\____/|____/ |__|  \\___  >__|   "),console.log("                     \\/         \\/         \\/                        \\/       v "+a.version.toString()),console.log("                 is listening on port "+82..toString()),console.log();const c=n.default.createServer(),l=r.default(c);new o.Router(l);c.listen(82)},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("socket.io")},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Router=void 0;const n=s(i(2)),r=i(7),o=i(8),a=i(11),c=i(12),l=i(0);t.Router=class{constructor(e){this.clients=new n.default,this.servers=new n.default,console.log("> Router initialized ... waiting for incoming connections"),e.on("connection",e=>{this.onconnect(e)})}onconnect(e){const t=new r.SocketDescriptor(this,e);switch(console.log("Client connected ["+t.getClientType()+" "+t.id+"] from ["+t.getRemoteAddress()+"] as ["+t.getUser().username+"]"),t.type){case l.ClientType.PIMIXPLAYER:{const e=new o.PimixPlayer(t);this.servers.set(t.id,e),this.broadcast({command:l.ClientCommand.SERVERLIST,recipient:l.ClientType.MIXER,param:this.getServerListDescription()});break}case l.ClientType.MIXER:{const e=new c.WebMixer(t);void 0!==this.scanner&&e.sendPacket({command:l.ClientCommand.SCANNER,recipient:l.ClientType.MIXER,param:this.scanner.geScannerDescription()}),this.clients.set(e.id,e);break}case l.ClientType.PLAYER:{const e=new c.WebPlayer(t);this.clients.set(e.id,e);break}case l.ClientType.PLAYLIST:{const e=new c.WebPlaylist(t);this.clients.set(t.id,e);break}case l.ClientType.TOASTER:{const e=new c.WebToaster(t);this.clients.set(t.id,e);break}case l.ClientType.SEARCH:{const e=new c.WebSearch(t);this.clients.set(t.id,e);break}case l.ClientType.SCANNER:this.scanner=new a.PimixScanner(t,this);break;default:console.log("connect: invalid socket descriptor received ... ignoring ["+t.type.toString()+"]")}}ondisconnect(e){switch(console.log("Client disconnected ["+e.getClientType()+" "+e.id+"] from ["+e.getRemoteAddress()+"]"),e.type){case l.ClientType.PIMIXPLAYER:{const t=this.servers.get(e.id);null!==t&&(this.servers.remove(e.id),t.shutdown(),this.broadcast({command:l.ClientCommand.SERVERLIST,recipient:l.ClientType.MIXER,param:this.getServerListDescription()}));break}case l.ClientType.SCANNER:void 0!==this.scanner&&this.scanner.shutdown();break;case l.ClientType.MIXER:case l.ClientType.PLAYER:case l.ClientType.PLAYLIST:case l.ClientType.TOASTER:case l.ClientType.SEARCH:{const t=this.clients.get(e.id);null!==t&&(void 0!==t.pimixplayer&&t.pimixplayer.detach(t),this.clients.remove(t.id));break}default:console.log("disconnect: invalid socket descriptor received ... ignoring")}}map(e,t){const i=this.clients.get(e.id);null!==i?void 0!==i.pimixplayer&&i.pimixplayer.detach(i):console.log("map: unable to find the client reference");const s=this.servers.get(t);null!=s?(s.attach(i),i.pimixplayer=s):console.log("map: unable to find the requested PimixPlayer")}broadcast(e){this.clients.forEach(t=>{t.isConcerned(e.recipient)&&t.sendPacket(e)})}getServerListDescription(){let e="";return this.servers.forEach(t=>{const i=t.getMixerDescription();null!==i&&(e+=(e.length>0?",":"")+i)}),"["+e+"]"}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SocketDescriptor=void 0;const s=i(0);class n{constructor(e,t){if(this._type=s.ClientType.UNKNOWN,this._router=e,this._socket=t,null!==t.handshake&&null!==t.handshake.query&&null!==t.handshake.query.binding){const e=JSON.parse(t.handshake.query.binding);this._type=n.getClientType(e.component);try{this._user=e.user}catch(e){}}}get id(){return this._socket.id}get socket(){return this._socket}set socket(e){this._socket=e}get type(){return this._type}get router(){return this._router}getClientType(){return s.ClientType[this._type]}getRemoteAddress(){return this.socket.request.connection.remoteAddress}getUser(){return void 0!==this._user?this._user:{id:0,username:"anonymous"}}static getClientType(e){return"pimixplayer"===e?s.ClientType.PIMIXPLAYER:"player"===e?s.ClientType.PLAYER:"playlist"===e?s.ClientType.PLAYLIST:"mixer"===e?s.ClientType.MIXER:"toaster"===e?s.ClientType.TOASTER:"search"===e?s.ClientType.SEARCH:"scanner"===e?s.ClientType.SCANNER:s.ClientType.UNKNOWN}}t.SocketDescriptor=n},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PimixPlayer=void 0;const n=s(i(2)),r=i(1),o=i(9),a=i(0),c=s(i(10));class l extends r.Client{constructor(e){super(e),this.clients=new n.default,this.mixer=new o.Mixer,this.playlist={playingUUID:"",list:[]},this.votes=new n.default,this.mixer.setId(this.id),this.mixer.copy(e.socket.request.headers.mixer),this.tracks=[],this.sd.socket.on(a.ServerCommand.PLAYERINIT,e=>{const{playlist:t,votes:i}=JSON.parse(e),s=JSON.parse(t);if(this.playlist.playingUUID=s.playingUUID,this.playlist.list=s.list,void 0!==i){const e=JSON.parse(i);c.default.forEach(e,e=>{this.votes.set(e.uuid,e)})}}),this.sd.socket.on(a.ServerCommand.TRACK,e=>{this.broadcast({command:a.ClientCommand.TRACK,recipient:a.ClientType.MIXER,param:e})}),this.sd.socket.on(a.ServerCommand.MIXER,e=>{this.mixer.copy(e),this.broadcast({command:a.ClientCommand.MIXER,recipient:a.ClientType.MIXER,param:e}),this.broadcast({command:a.ClientCommand.MIXER,recipient:a.ClientType.PLAYER,param:e}),this.broadcast({command:a.ClientCommand.MIXER,recipient:a.ClientType.PLAYLIST,param:e})}),this.sd.socket.on(a.ServerCommand.PLAYLISTADD,e=>{this.addToPlaylist(e)}),this.sd.socket.on(a.ServerCommand.VOTE,e=>{this.register(e)}),this.sd.socket.on(a.ServerCommand.MESSAGE,e=>{this.broadcast({command:a.ClientCommand.MESSAGE,recipient:a.ClientType.TOASTER,param:e})})}attach(e){this.clients.set(e.id,e),this.mixer.setNbClients(this.clients.keys().length),this.broadcast({command:a.ClientCommand.USERS,recipient:a.ClientType.MIXER,param:this.getNbClients(a.ClientType.MIXER).toString()})}detach(e){this.clients.remove(e.id),this.mixer.setNbClients(this.clients.keys().length),this.broadcast({command:a.ClientCommand.USERS,recipient:a.ClientType.MIXER,param:this.getNbClients(a.ClientType.MIXER).toString()})}shutdown(){this.clients.forEach(e=>{e.pimixplayer=void 0}),this.clients.clear()}getMixerDescription(){return JSON.stringify(this.mixer)}broadcast(e){this.clients.forEach(t=>{t.isConcerned(e.recipient)&&t.sendPacket(e)})}sendPacket(e,t){this.sd.socket.emit(e.command,e.param,t)}getCurrentSong(){return JSON.stringify(this.tracks[this.mixer.activetrack])}getNbClients(e){const t=c.default.countBy(this.clients.values(),t=>t.isConcerned(e));return void 0!==t.true?t.true:0}addToPlaylist(e){const{item:t,index:i}=JSON.parse(e);this.playlist.list.splice(i,0,t),this.broadcast({command:a.ClientCommand.PLAYLISTADD,recipient:a.ClientType.PLAYLIST,param:e})}getPlaylist(){return JSON.stringify(this.playlist)}getVotes(){return JSON.stringify(this.votes.values())}register(e){const t=JSON.parse(e);t.points<0||0===t.votes.length||t.executed?this.votes.remove(t.uuid):this.votes.set(t.uuid,t),this.broadcast({command:a.ClientCommand.VOTE,recipient:a.ClientType.PLAYLIST,param:e})}}t.PimixPlayer=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Mixer=void 0;t.Mixer=class{constructor(){this.id="",this.sessionid="",this.name="",this.nbtracks=0,this.activetrack=1,this.autoplay=!1,this.shuffle=!1,this.gain=0,this.volume=0,this.seekmode=0,this.seeklength=0,this.leavemode=0,this.leavelength=0,this.fadeinduration=0,this.fadeoutduration=0,this.nbclients=0}copy(e){const{sessionid:t,name:i,nbtracks:s,activetrack:n,autoplay:r,shuffle:o,gain:a,volume:c,seekmode:l,seeklength:d,leavemode:p,leavelength:m,fadeinduration:h,fadeoutduration:u}=JSON.parse(e);this.sessionid=t,this.name=i,this.nbtracks=s,this.activetrack=n,this.autoplay=r,this.shuffle=o,this.gain=a,this.volume=c,this.seekmode=l,this.seeklength=d,this.leavemode=p,this.leavelength=m,this.fadeinduration=h,this.fadeoutduration=u}setNbClients(e){this.nbclients=e}setId(e){this.id=e}}},function(e,t){e.exports=require("lodash")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PimixScanner=void 0;const s=i(1),n=i(0);class r extends s.Client{constructor(e,t){super(e),this.scanner={connected:!1,since:null,nbsongs:0,queue:0,completed:0,failed:0},this.router=t,this.sd.socket.on(n.ScannerCommand.UPDATE,e=>{const{nbsongs:t,since:i,queue:s,completed:n,failed:r}=JSON.parse(e);this.scanner.connected=!0,this.scanner.nbsongs=t,this.scanner.since=i,this.scanner.queue=s,this.scanner.completed=n,this.scanner.failed=r,this.broadcast()})}geScannerDescription(){return JSON.stringify(this.scanner)}shutdown(){this.scanner.connected=!1,this.broadcast()}broadcast(){this.router.broadcast({command:n.ClientCommand.SCANNER,recipient:n.ClientType.MIXER,param:this.geScannerDescription()})}}t.PimixScanner=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebSearch=t.WebToaster=t.WebPlaylist=t.WebPlayer=t.WebMixer=void 0;const s=i(13),n=i(0);class r extends s.WebClient{connected(){this.sendPacket({command:n.ClientCommand.SERVERLIST,param:this.sd.router.getServerListDescription()})}}t.WebMixer=r;class o extends s.WebClient{attached(){if(void 0!==this.pimixplayer){const e=this.pimixplayer.getMixerDescription();void 0!==e&&this.sendPacket({command:n.ClientCommand.MIXER,param:e})}}}t.WebPlayer=o;class a extends s.WebClient{attached(){if(void 0!==this.pimixplayer){const e=this.pimixplayer.getPlaylist();void 0!==e&&this.sendPacket({command:n.ClientCommand.PLAYLISTINIT,param:e});const t=this.pimixplayer.getVotes();void 0!==t&&this.sendPacket({command:n.ClientCommand.VOTESINIT,param:t});const i=this.pimixplayer.getMixerDescription();void 0!==i&&this.sendPacket({command:n.ClientCommand.MIXER,param:i})}}}t.WebPlaylist=a;class c extends s.WebClient{}t.WebToaster=c;class l extends s.WebClient{}t.WebSearch=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebClient=void 0;const s=i(1),n=i(0);class r extends s.Client{constructor(e){super(e),this.sd.socket.on(n.ServerCommand.MAP,e=>{this.sd.router.map(this.sd,e)}),this.sd.socket.on(n.ServerCommand.COMMAND,e=>{this.broadcast({command:n.ServerCommand.COMMAND,param:e})}),this.connected()}get pimixplayer(){return this._pimixPlayer}set pimixplayer(e){this._pimixPlayer=e,void 0!==this._pimixPlayer?(this.sendPacket({command:n.ClientCommand.ATTACHED,param:this._pimixPlayer.getMixerDescription()}),this.attached()):(this.sendPacket({command:n.ClientCommand.DETACHED}),this.detached())}isAttached(){return void 0!==this._pimixPlayer}connected(){}attached(){}detached(){}broadcast(e){void 0!==this._pimixPlayer&&this._pimixPlayer.sendPacket(e,JSON.stringify(this.sd.getUser()))}sendPacket(e){this.sd.socket.emit(e.command,e.param)}}t.WebClient=r},function(e){e.exports=JSON.parse('{"name":"pimix-router","version":"1.0.5","description":"Websocket router, dispatch commands and events between PiMix Player and PiMix WebComponents (Controller,Playlist,Mixer,Quiz)","main":"index.js","scripts":{"router":"nodemon ./dist/router.js","build":"rm -rf dist && webpack","dev":"webpack --watch"},"repository":{"type":"git","url":"git+https://github.com/vbarrois/pimix-router.git"},"author":"Vincent Barrois","license":"ISC","bugs":{"url":"https://github.com/vbarrois/pimix-router/issues"},"homepage":"https://github.com/vbarrois/pimix-router#readme","dependencies":{"@types/hashmap":"^2.3.0","@types/lodash":"^4.14.149","@types/node":"^12.11.6","@types/socket.io":"^2.1.4","@typescript-eslint/eslint-plugin":"^2.6.0","concurrently":"^5.2.0","eslint":"^6.6.0","eslint-config-standard-with-typescript":"^10.0.0","eslint-loader":"^4.0.2","eslint-plugin-import":"^2.18.2","eslint-plugin-node":"^10.0.0","eslint-plugin-promise":"^4.2.1","eslint-plugin-standard":"^4.0.1","ts-loader":"^7.0.4","typescript":"^3.6.4","webpack":"^4.43.0","webpack-cli":"^3.3.11","webpack-node-externals":"^1.7.2","colors":"^1.4.0","hashmap":"^2.4.0","lodash":"^4.17.15","nodemon":"^1.19.4","socket.io":"^2.3.0"}}')}]);