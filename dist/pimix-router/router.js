!function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=5)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WIFICommand=t.ScannerCommand=t.ClientCommand=t.ServerCommand=t.ClientType=void 0,function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.PIMIXPLAYER=1]="PIMIXPLAYER",e[e.MIXER=2]="MIXER",e[e.PLAYER=3]="PLAYER",e[e.PLAYLIST=4]="PLAYLIST",e[e.TOASTER=5]="TOASTER",e[e.SEARCH=6]="SEARCH",e[e.SCANNER=7]="SCANNER",e[e.WIFI=8]="WIFI",e[e.WIFISCANNER=9]="WIFISCANNER"}(t.ClientType||(t.ClientType={})),function(e){e.MAP="map",e.COMMAND="command",e.PLAYERINIT="player_init",e.TRACK="track",e.MIXER="mixer",e.PLAYLISTADD="playlist_add",e.MESSAGE="message",e.VOTE="vote"}(t.ServerCommand||(t.ServerCommand={})),function(e){e.SERVERLIST="serverlist",e.SCANNER="scanner",e.PLAYPAUSE="play",e.NEXT="next",e.ATTACHED="attached",e.DETACHED="detached",e.MIXER="mixer",e.USERS="users",e.PLAYLISTINIT="playlist_init",e.PLAYLISTADD="playlist_add",e.PLAYLISTINDEX="playlist_index",e.MESSAGE="message",e.VOTESINIT="votes_init",e.VOTE="vote",e.TRACK="track",e.WIFISCAN="scan"}(t.ClientCommand||(t.ClientCommand={})),function(e){e.UPDATE="update"}(t.ScannerCommand||(t.ScannerCommand={})),function(e){e.SCAN="scan",e.MESSAGE="message"}(t.WIFICommand||(t.WIFICommand={}))},function(e,t){e.exports=require("lodash")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;t.Client=class{constructor(e){this.sd=e,this.sd.socket.on("disconnect",()=>{this.sd.router.ondisconnect(this.sd)})}get id(){return this.sd.id}get mac(){return this.sd.mac}isConcerned(e){return this.sd.type===e}}},function(e,t){e.exports=require("hashmap")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Mixer=t.WIFIInterface=void 0;t.WIFIInterface=class{constructor(){this.connected=!1,this.interface="",this.ssid="",this.networks=[]}};t.Mixer=class{constructor(){this.id="",this.sessionid="",this.name="",this.nbtracks=0,this.activetrack=1,this.playonstart=!1,this.shuffle=!1,this.gain=0,this.volume=0,this.seekmode=0,this.seeklength=0,this.leavemode=0,this.leavelength=0,this.fadeinduration=0,this.fadeoutduration=0,this.nbclients=0}copy(e){const{sessionid:t,name:i,nbtracks:s,activetrack:n,playonstart:r,shuffle:a,gain:o,volume:c,seekmode:l,seeklength:d,leavemode:h,leavelength:m,fadeinduration:p,fadeoutduration:u}=JSON.parse(e);this.sessionid=t,this.name=i,this.nbtracks=s,this.activetrack=n,this.playonstart=r,this.shuffle=a,this.gain=o,this.volume=c,this.seekmode=l,this.seeklength=d,this.leavemode=h,this.leavelength=m,this.fadeinduration=p,this.fadeoutduration=u}setNbClients(e){this.nbclients=e}setId(e){this.id=e}}},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(6)),r=s(i(7)),a=i(8),o=i(15);console.clear(),console.log("__________.__   _____  .__         __________               __                "),console.log("\\______   \\__| /     \\ |__|__  ___ \\______   \\ ____  __ ___/  |_  ___________ "),console.log(" |     ___/  |/  \\ /  \\|  \\  \\/  /  |       _//  _ \\|  |  \\   __\\/ __ \\_  __ \\"),console.log(" |    |   |  /    Y    \\  |>    <   |    |   (  <_> )  |  /|  | \\  ___/|  | \\/"),console.log(" |____|   |__\\____|__  /__/__/\\_ \\  |____|_  /\\____/|____/ |__|  \\___  >__|   "),console.log("                     \\/         \\/         \\/                        \\/       v "+o.version.toString()),console.log("                 is listening on port "+82..toString()),console.log();const c=n.default.createServer(),l=r.default(c);new a.Router(l);c.listen(82)},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("socket.io")},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Router=void 0;const n=s(i(3)),r=i(9),a=i(10),o=i(11),c=i(12),l=i(0),d=i(14),h=s(i(1));t.Router=class{constructor(e){this.clients=new n.default,this.servers=new n.default,this.wifiinterfaces=new n.default,console.log("> Router initialized ... waiting for incoming connections"),e.on("connection",e=>{this.onconnect(e)})}onconnect(e){const t=new r.SocketDescriptor(this,e);switch(console.log("Client connected"+t.toString()),t.type){case l.ClientType.PIMIXPLAYER:{const e=new a.PimixPlayer(t);this.servers.set(t.id,e);const i=this.wifiinterfaces.get(e.mac);h.default.isNil(i)||e.attachWIFIInterface(i),this.broadcast({command:l.ClientCommand.SERVERLIST,recipient:l.ClientType.MIXER,param:this.getServerListDescription()});break}case l.ClientType.MIXER:{const e=new c.WebMixer(t);h.default.isNil(this.scanner)||e.sendPacket({command:l.ClientCommand.SCANNER,recipient:l.ClientType.MIXER,param:this.scanner.geScannerDescription()}),this.clients.set(e.id,e);break}case l.ClientType.PLAYER:{const e=new c.WebPlayer(t);this.clients.set(e.id,e);break}case l.ClientType.PLAYLIST:{const e=new c.WebPlaylist(t);this.clients.set(t.id,e);break}case l.ClientType.TOASTER:{const e=new c.WebToaster(t);this.clients.set(t.id,e);break}case l.ClientType.SEARCH:{const e=new c.WebSearch(t);this.clients.set(t.id,e);break}case l.ClientType.WIFI:{const e=new c.WebWIFI(t);this.clients.set(t.id,e);break}case l.ClientType.SCANNER:this.scanner=new o.PimixScanner(t,this);break;case l.ClientType.WIFISCANNER:{const e=new d.PimixWifi(t);this.wifiinterfaces.set(t.mac,e);const i=this.servers.values(),s=h.default.find(i,t=>t.mac===e.mac);h.default.isNil(s)||s.attachWIFIInterface(e);break}default:console.log("connect: invalid socket descriptor received ... ignoring ["+t.type.toString()+"]")}}ondisconnect(e){switch(console.log("Client disconnected ["+e.getClientType()+" "+e.id+"] from ["+e.getRemoteAddress()+"]"),e.type){case l.ClientType.PIMIXPLAYER:{const t=this.servers.get(e.id);h.default.isNil(t)||(this.servers.delete(e.id),t.shutdown(),this.broadcast({command:l.ClientCommand.SERVERLIST,recipient:l.ClientType.MIXER,param:this.getServerListDescription()}));break}case l.ClientType.SCANNER:h.default.isNil(this.scanner)||this.scanner.shutdown();break;case l.ClientType.WIFISCANNER:{const t=this.wifiinterfaces.get(e.id);h.default.isNil(t)||t.shutdown();break}case l.ClientType.MIXER:case l.ClientType.PLAYER:case l.ClientType.PLAYLIST:case l.ClientType.TOASTER:case l.ClientType.SEARCH:{const t=this.clients.get(e.id);h.default.isNil(t)||(h.default.isNil(t.pimixplayer)||t.pimixplayer.detach(t),this.clients.delete(t.id));break}default:console.log("disconnect: invalid socket descriptor received ... ignoring")}}map(e,t){const i=this.clients.get(e.id);h.default.isNil(i)?console.log("map: unable to find the client reference"):h.default.isNil(i.pimixplayer)||i.pimixplayer.detach(i);const s=this.servers.get(t);null!=s?(s.attach(i),i.pimixplayer=s):console.log("map: unable to find the requested PimixPlayer")}broadcast(e){this.clients.forEach(t=>{t.isConcerned(e.recipient)&&t.sendPacket(e)})}getServerListDescription(){let e="";return this.servers.forEach(t=>{const i=t.getMixerDescription();h.default.isNil(i)||(e+=(e.length>0?",":"")+i)}),"["+e+"]"}}},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SocketDescriptor=void 0;const n=i(0),r=s(i(1));class a{constructor(e,t){if(this._type=n.ClientType.UNKNOWN,this._mac="",this._router=e,this._socket=t,!r.default.isNil(t.handshake.query.binding)){const e=JSON.parse(t.handshake.query.binding);this._type=a.getClientType(e.component),this._mac=r.default.replace(e.ID,/-/g,":").toUpperCase();try{this._user=e.user}catch(e){console.log("Socket descriptor fail "+e.toString())}}}toString(){return" ["+this.getClientType()+" "+this.id+"/"+this.mac+"] from ["+this.getRemoteAddress()+"] as ["+this.getUser().username+"]"}get id(){return this._socket.id}get mac(){return this._mac}get socket(){return this._socket}set socket(e){this._socket=e}get type(){return this._type}get router(){return this._router}getClientType(){return n.ClientType[this._type]}getRemoteAddress(){return this.socket.request.connection.remoteAddress}getUser(){return r.default.isNil(this._user)?{id:0,username:"anonymous"}:this._user}static getClientType(e){return"pimixplayer"===e?n.ClientType.PIMIXPLAYER:"player"===e?n.ClientType.PLAYER:"playlist"===e?n.ClientType.PLAYLIST:"mixer"===e?n.ClientType.MIXER:"toaster"===e?n.ClientType.TOASTER:"search"===e?n.ClientType.SEARCH:"scanner"===e?n.ClientType.SCANNER:"wifiscanner"===e?n.ClientType.WIFISCANNER:"wifi"===e?n.ClientType.WIFI:n.ClientType.UNKNOWN}}t.SocketDescriptor=a},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PimixPlayer=void 0;const n=s(i(3)),r=i(2),a=i(4),o=i(0),c=s(i(1));class l extends r.Client{constructor(e){super(e),this.clients=new n.default,this.mixer=new a.Mixer,this.playlist={playingUUID:"",list:[]},this.votes=new n.default,this.mixer.setId(this.id),this.mixer.copy(e.socket.request.headers.mixer),this.tracks=[],this.sd.socket.on(o.ServerCommand.PLAYERINIT,e=>{const{playlist:t,votes:i}=JSON.parse(e),s=JSON.parse(t);if(this.playlist.playingUUID=s.playingUUID,this.playlist.list=s.list,!c.default.isNil(i)){const e=JSON.parse(i);c.default.forEach(e,e=>{this.votes.set(e.uuid,e)})}}),this.sd.socket.on(o.ServerCommand.TRACK,e=>{this.broadcast({command:o.ClientCommand.TRACK,recipient:o.ClientType.MIXER,param:e})}),this.sd.socket.on(o.ServerCommand.MIXER,e=>{this.mixer.copy(e),this.broadcast({command:o.ClientCommand.MIXER,recipient:o.ClientType.MIXER,param:e}),this.broadcast({command:o.ClientCommand.MIXER,recipient:o.ClientType.PLAYER,param:e}),this.broadcast({command:o.ClientCommand.MIXER,recipient:o.ClientType.PLAYLIST,param:e})}),this.sd.socket.on(o.ServerCommand.PLAYLISTADD,e=>{this.addToPlaylist(e)}),this.sd.socket.on(o.ServerCommand.VOTE,e=>{this.register(e)}),this.sd.socket.on(o.ServerCommand.MESSAGE,e=>{this.broadcast({command:o.ClientCommand.MESSAGE,recipient:o.ClientType.TOASTER,param:e})})}attachWIFIInterface(e){console.log("WIFI attached to player"),this.wifi=e,this.wifi.attachPimixPlayer(this),this.broadcastWIFI()}detachWIFIInterface(){this.broadcastWIFI(),this.wifi=void 0}broadcastWIFI(){c.default.isNil(this.wifi)||(console.log("broadcast wifi"),this.broadcast({command:o.ClientCommand.WIFISCAN,recipient:o.ClientType.WIFI,param:this.wifi.geWifiDescription()}))}broadcastWIFIMesssage(e){this.broadcast({command:o.ClientCommand.MESSAGE,recipient:o.ClientType.TOASTER,param:JSON.stringify(e)})}isWIFIConnected(){return!c.default.isNil(this.wifi)}getWIFI(){return this.wifi}attach(e){this.clients.set(e.id,e),this.mixer.setNbClients(this.clients.keys().length),this.broadcast({command:o.ClientCommand.USERS,recipient:o.ClientType.MIXER,param:this.getNbClients(o.ClientType.MIXER).toString()})}detach(e){this.clients.delete(e.id),this.mixer.setNbClients(this.clients.keys().length),this.broadcast({command:o.ClientCommand.USERS,recipient:o.ClientType.MIXER,param:this.getNbClients(o.ClientType.MIXER).toString()})}shutdown(){c.default.isNil(this.wifi)||this.wifi.detachPimixPlayer(),this.clients.forEach(e=>{e.pimixplayer=void 0}),this.clients.clear()}getMixerDescription(){return JSON.stringify(this.mixer)}getWIFIList(){if(!c.default.isNil(this.wifi)){return this.wifi.geWifiDescription()}}broadcast(e){this.clients.forEach(t=>{t.isConcerned(e.recipient)&&t.sendPacket(e)})}sendPacket(e,t){this.sd.socket.emit(e.command,e.param,t)}getCurrentSong(){return JSON.stringify(this.tracks[this.mixer.activetrack])}getNbClients(e){const t=c.default.countBy(this.clients.values(),t=>t.isConcerned(e));return c.default.isNil(t.true)?0:t.true}addToPlaylist(e){const{item:t,index:i}=JSON.parse(e);this.playlist.list.splice(i,0,t),this.broadcast({command:o.ClientCommand.PLAYLISTADD,recipient:o.ClientType.PLAYLIST,param:e})}getPlaylist(){return JSON.stringify(this.playlist)}getVotes(){return JSON.stringify(this.votes.values())}register(e){const t=JSON.parse(e);t.points<0||0===t.votes.length||t.executed?this.votes.delete(t.uuid):this.votes.set(t.uuid,t),this.broadcast({command:o.ClientCommand.VOTE,recipient:o.ClientType.PLAYLIST,param:e})}}t.PimixPlayer=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PimixScanner=void 0;const s=i(2),n=i(0);class r extends s.Client{constructor(e,t){super(e),this.scanner={connected:!1,since:null,nbsongs:0,queue:0,completed:0,failed:0},this.router=t,this.sd.socket.on(n.ScannerCommand.UPDATE,e=>{const{nbsongs:t,since:i,queue:s,completed:n,failed:r}=JSON.parse(e);this.scanner.connected=!0,this.scanner.nbsongs=t,this.scanner.since=i,this.scanner.queue=s,this.scanner.completed=n,this.scanner.failed=r,this.broadcast()})}geScannerDescription(){return JSON.stringify(this.scanner)}shutdown(){this.scanner.connected=!1,this.broadcast()}broadcast(){this.router.broadcast({command:n.ClientCommand.SCANNER,recipient:n.ClientType.MIXER,param:this.geScannerDescription()})}}t.PimixScanner=r},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebWIFI=t.WebSearch=t.WebToaster=t.WebPlayer=t.WebPlaylist=t.WebMixer=void 0;const n=i(13),r=i(0),a=s(i(1));class o extends n.WebClient{connected(){this.sendPacket({command:r.ClientCommand.SERVERLIST,param:this.sd.router.getServerListDescription()})}attached(){if(!a.default.isNil(this.pimixplayer)){const e=this.pimixplayer.getMixerDescription();a.default.isNil(e)||this.sendPacket({command:r.ClientCommand.MIXER,param:e})}}}t.WebMixer=o;class c extends n.WebClient{attached(){if(!a.default.isNil(this.pimixplayer)){const e=this.pimixplayer.getPlaylist();a.default.isNil(e)||this.sendPacket({command:r.ClientCommand.PLAYLISTINIT,param:e});const t=this.pimixplayer.getVotes();a.default.isNil(t)||this.sendPacket({command:r.ClientCommand.VOTESINIT,param:t})}}}t.WebPlaylist=c;class l extends n.WebClient{}t.WebPlayer=l;class d extends n.WebClient{}t.WebToaster=d;class h extends n.WebClient{}t.WebSearch=h;class m extends n.WebClient{attached(){this.sendWIFIScan()}sendWIFIScan(){if(!a.default.isNil(this.pimixplayer)&&this.pimixplayer.isWIFIConnected()){const e=this.pimixplayer.getWIFIList();a.default.isNil(e)||this.sendPacket({command:r.ClientCommand.WIFISCAN,param:e})}}broadcast(e){if(!a.default.isNil(this.pimixplayer)){const t=this.pimixplayer.getWIFI();a.default.isNil(t)||t.sendPacket(e,JSON.stringify(this.sd.getUser()))}}}t.WebWIFI=m},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebClient=void 0;const n=i(2),r=i(0),a=s(i(1));class o extends n.Client{constructor(e){super(e),this.sd.socket.on(r.ServerCommand.MAP,e=>{this.sd.router.map(this.sd,e)}),this.sd.socket.on(r.ServerCommand.COMMAND,e=>{this.broadcast({command:r.ServerCommand.COMMAND,param:e})}),this.connected()}get pimixplayer(){return this._pimixPlayer}set pimixplayer(e){this._pimixPlayer=e,a.default.isNil(this._pimixPlayer)?(this.sendPacket({command:r.ClientCommand.DETACHED}),this.detached()):(this.sendPacket({command:r.ClientCommand.ATTACHED,param:this._pimixPlayer.getMixerDescription()}),this.attached())}isAttached(){return!a.default.isNil(this._pimixPlayer)}connected(){}attached(){}detached(){}broadcast(e){a.default.isNil(this._pimixPlayer)||this._pimixPlayer.sendPacket(e,JSON.stringify(this.sd.getUser()))}sendPacket(e){this.sd.socket.emit(e.command,e.param)}}t.WebClient=o},function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PimixWifi=void 0;const n=i(2),r=i(0),a=i(4),o=s(i(1));class c extends n.Client{constructor(e){super(e),this.wifi=new a.WIFIInterface,this.sd.socket.on(r.WIFICommand.SCAN,e=>{const t=JSON.parse(e);this.wifi.connected=!0,this.wifi.interface=t.interface,this.wifi.ssid=t.ssid,this.wifi.networks=t.networks,console.log(t),o.default.isNil(this.pimixPlayer)||this.pimixPlayer.broadcastWIFI()}),this.sd.socket.on(r.WIFICommand.MESSAGE,e=>{o.default.isNil(this.pimixPlayer)||this.pimixPlayer.broadcastWIFIMesssage(e)})}attachPimixPlayer(e){this.pimixPlayer=e}detachPimixPlayer(){this.pimixPlayer=void 0}geWifiDescription(){return JSON.stringify(this.wifi)}shutdown(){this.wifi.connected=!1,this.wifi.interface="",this.wifi.ssid="",this.wifi.networks=[],o.default.isNil(this.pimixPlayer)||this.pimixPlayer.detachWIFIInterface(),this.pimixPlayer=void 0}sendPacket(e,t){this.sd.socket.emit(e.command,e.param,t)}}t.PimixWifi=c},function(e){e.exports=JSON.parse('{"name":"pimix-router","version":"1.0.7","description":"Websocket router, dispatch commands and events between PiMix Player and PiMix WebComponents (Controller,Playlist,Mixer,Quiz)","main":"index.js","scripts":{"router":"nodemon ./dist/router.js","build":"rm -rf dist && webpack","dev":"webpack --watch"},"repository":{"type":"git","url":"git+https://github.com/vbarrois/pimix-router.git"},"author":"Vincent Barrois","license":"ISC","bugs":{"url":"https://github.com/vbarrois/pimix-router/issues"},"homepage":"https://github.com/vbarrois/pimix-router#readme","dependencies":{"@types/hashmap":"^2.3.0","@types/lodash":"^4.14.149","@types/node":"^12.11.6","@types/socket.io":"^2.1.4","@typescript-eslint/eslint-plugin":"^2.6.0","colors":"^1.4.0","concurrently":"^5.2.0","eslint":"^6.6.0","eslint-config-standard-with-typescript":"^10.0.0","eslint-loader":"^4.0.2","eslint-plugin-import":"^2.18.2","eslint-plugin-node":"^10.0.0","eslint-plugin-promise":"^4.2.1","eslint-plugin-standard":"^4.0.1","hashmap":"^2.4.0","lodash":"^4.17.20","node-wifi":"^2.0.13","nodemon":"^1.19.4","socket.io":"^2.3.0","ts-loader":"^7.0.4","typescript":"^3.6.4","webpack":"^4.43.0","webpack-cli":"^3.3.11","webpack-node-externals":"^1.7.2"}}')}]);