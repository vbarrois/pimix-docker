(()=>{"use strict";var e={366:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0,t.Client=class{constructor(e){this.sd=e,this.sd.socket.on("disconnect",(()=>{this.sd.router.ondisconnect(this.sd)}))}get id(){return this.sd.id}get mac(){return this.sd.mac}get user(){return this.sd.getUser()}isConcerned(e){return this.sd.type===e}}},399:(e,t)=>{var i,s,n,a;Object.defineProperty(t,"__esModule",{value:!0}),t.WIFICommand=t.ScannerCommand=t.ClientCommand=t.ServerCommand=t.ClientType=void 0,(a=t.ClientType||(t.ClientType={}))[a.UNKNOWN=0]="UNKNOWN",a[a.PIMIXPLAYER=1]="PIMIXPLAYER",a[a.SCANNER=2]="SCANNER",a[a.WIFISCANNER=3]="WIFISCANNER",a[a.INTERFACE=4]="INTERFACE",(n=t.ServerCommand||(t.ServerCommand={})).MAP="map",n.COMMAND="command",n.INIT="init",n.TRACK="track",n.MIXER="mixer",n.PLAYLISTADD="playlist_add",n.MESSAGE="message",n.VOTE="vote",n.QUEUE="queue",n.USERS="users",n.QUIZ="quiz",(s=t.ClientCommand||(t.ClientCommand={})).SERVERLIST="serverlist",s.SCANNER="scanner",s.PLAYPAUSE="play",s.NEXT="next",s.ATTACHED="attached",s.DETACHED="detached",s.MIXER="mixer",s.QUIZ="quiz",s.USERS="users",s.MESSAGE="message",s.VOTESINIT="votes_init",s.VOTE="vote",s.QUEUEINIT="queue_init",s.QUEUE="queue",s.TRACK="track",s.WIFISCAN="scan",(t.ScannerCommand||(t.ScannerCommand={})).UPDATE="update",(i=t.WIFICommand||(t.WIFICommand={})).SCAN="scan",i.MESSAGE="message"},341:function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(685)),a=i(952),r=i(551),o=i(147);console.clear(),console.log("__________.__   _____  .__         __________               __                "),console.log("\\______   \\__| /     \\ |__|__  ___ \\______   \\ ____  __ ___/  |_  ___________ "),console.log(" |     ___/  |/  \\ /  \\|  \\  \\/  /  |       _//  _ \\|  |  \\   __\\/ __ \\_  __ \\"),console.log(" |    |   |  /    Y    \\  |>    <   |    |   (  <_> )  |  /|  | \\  ___/|  | \\/"),console.log(" |____|   |__\\____|__  /__/__/\\_ \\  |____|_  /\\____/|____/ |__|  \\___  >__|   "),console.log("                     \\/         \\/         \\/                        \\/ "+o.version),console.log("                 is listening on port "+82..toString()),console.log(),process.env.PACKAGE;const c=n.default.createServer(),d=new a.Server(c);new r.Router(d),c.listen(82)},8:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Mixer=t.Quiz=t.WIFIInterface=void 0,t.WIFIInterface=class{constructor(){this.connected=!1,this.interface="",this.ssid="",this.networks=[]}},t.Quiz=class{constructor(){this.state="stop",this.mode="",this.difficulty=0,this.playdurattion=0,this.transitionduration=0,this.roundcount=0}copy(e){this.state=e.state,this.mode=e.mode,this.difficulty=e.difficulty,this.roundcount=e.roundcount,this.playdurattion=e.playduration,this.transitionduration=e.transitionduration,this.oResult=e.result,this.oPropositions=e.propositions}saveBoard(e){this.oBoard=e}savePropositions(e){this.oResult=e.result,this.oPropositions=e.propositions}getJSON(){return{state:this.state,mode:this.mode,difficulty:this.difficulty,playduration:this.playdurattion,roundcount:this.roundcount,transitionduration:this.transitionduration,board:this.oBoard,result:this.oResult,propositions:this.oPropositions}}},t.Mixer=class{constructor(){this.id="",this.sessionid="",this.name="",this.nbtracks=0,this.activetrack=1,this.playonstart=!1,this.wait4freetrack=!1,this.playmode="next",this.nextmode="discover",this.notplayedsince=0,this.gain=0,this.volume=0,this.seekmode=0,this.seeklength=0,this.leavemode=0,this.leavelength=0,this.fadeinduration=0,this.fadeoutduration=0,this.nbclients=0}copy(e){const{sessionid:t,name:i,nbtracks:s,activetrack:n,playonstart:a,wait4freetrack:r,playmode:o,nextmode:c,notplayedsince:d,gain:l,volume:h,seekmode:u,seeklength:m,leavemode:p,leavelength:f,fadeinduration:C,fadeoutduration:_}=JSON.parse(e);this.sessionid=t,this.name=i,this.nbtracks=s,this.activetrack=n,this.playonstart=a,this.wait4freetrack=r,this.nextmode=c,this.notplayedsince=d,this.playmode=o,this.gain=l,this.volume=h,this.seekmode=u,this.seeklength=m,this.leavemode=p,this.leavelength=f,this.fadeinduration=C,this.fadeoutduration=_}setNbClients(e){this.nbclients=e}setId(e){this.id=e}}},525:function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PimixPlayer=void 0;const n=s(i(299)),a=i(366),r=i(8),o=i(399),c=s(i(517));class d extends a.Client{constructor(e){super(e),this.clients=new n.default,this.mixer=new r.Mixer,this.queue={playingUUID:"",list:[]},this.votes=new n.default,this.quiz=new r.Quiz,this.mixer.setId(this.id),this.mixer.copy(`${e.socket.request.headers.mixer}`),this.tracks=[],this.sd.socket.on(o.ServerCommand.INIT,(e=>{const{queue:t,votes:i}=JSON.parse(e),s=JSON.parse(t);if(this.queue.playingUUID=s.playingUUID,this.queue.list=s.list,!c.default.isNil(i)){const e=JSON.parse(i);c.default.forEach(e,(e=>{this.votes.set(e.uuid,e)}))}c.default.forEach(this.clients.values(),(e=>{e.sendMixMeInitData()}))})),this.sd.socket.on(o.ServerCommand.TRACK,(e=>{var t;const i=JSON.parse(e).track;!c.default.isNil(null===(t=i.item)||void 0===t?void 0:t.uuid)&&i.active&&this.queue.playingUUID!==i.item.uuid&&(this.queue.playingUUID=i.item.uuid),this.broadcast({command:o.ClientCommand.TRACK,recipient:o.ClientType.INTERFACE,param:e})})),this.sd.socket.on(o.ServerCommand.MIXER,(e=>{this.mixer.copy(e),this.broadcast({command:o.ClientCommand.MIXER,recipient:o.ClientType.INTERFACE,param:e})})),this.sd.socket.on(o.ServerCommand.VOTE,(e=>{this.register(e)})),this.sd.socket.on(o.ServerCommand.QUEUE,(e=>{this.queueUpdate(e)})),this.sd.socket.on(o.ServerCommand.MESSAGE,(e=>{this.broadcast({command:o.ClientCommand.MESSAGE,recipient:o.ClientType.INTERFACE,param:e})})),this.sd.socket.on(o.ServerCommand.QUIZ,(e=>{const{event:t,arg:i}=JSON.parse(e);"board"===t?this.quiz.saveBoard(i):this.quiz.copy(i),this.broadcast({command:o.ClientCommand.QUIZ,recipient:o.ClientType.INTERFACE,param:e})}))}attachWIFIInterface(e){this.wifi=e,this.wifi.attachPimixPlayer(this),this.broadcastWIFI()}detachWIFIInterface(){this.broadcastWIFI(),this.wifi=void 0}broadcastWIFI(){c.default.isNil(this.wifi)||this.broadcast({command:o.ClientCommand.WIFISCAN,recipient:o.ClientType.INTERFACE,param:this.wifi.geWifiDescription()})}broadcastWIFIMesssage(e){this.broadcast({command:o.ClientCommand.MESSAGE,recipient:o.ClientType.INTERFACE,param:JSON.stringify(e)})}isWIFIConnected(){return!c.default.isNil(this.wifi)}getWIFI(){return this.wifi}attach(e){this.clients.set(e.id,e),this.mixer.setNbClients(this.clients.keys().length),this.broadcast({command:o.ClientCommand.USERS,recipient:o.ClientType.INTERFACE,param:JSON.stringify(this.getConnectedInterfaces())}),this.sendUsersToPlayer()}detach(e){this.clients.delete(e.id),this.mixer.setNbClients(this.clients.keys().length),this.broadcast({command:o.ClientCommand.USERS,recipient:o.ClientType.INTERFACE,param:JSON.stringify(this.getConnectedInterfaces())}),this.sendUsersToPlayer()}sendUsersToPlayer(){this.sendPacket({command:o.ServerCommand.COMMAND,param:JSON.stringify({action:"users",params:{list:this.getConnectedInterfaces()}})},"{ userlogin: 'router'}")}shutdown(){c.default.isNil(this.wifi)||this.wifi.detachPimixPlayer(),this.clients.forEach((e=>{e.pimixplayer=void 0})),this.clients.clear()}getMixerDescription(){return JSON.stringify(this.mixer)}getQuizInitMessage(){return JSON.stringify({event:"init",arg:this.quiz.getJSON()})}getWIFIList(){if(!c.default.isNil(this.wifi))return this.wifi.geWifiDescription()}broadcast(e){this.clients.forEach((t=>{t.isConcerned(e.recipient)&&t.sendPacket(e)}))}sendPacket(e,t){this.sd.socket.emit(e.command,e.param,t)}getCurrentSong(){return JSON.stringify(this.tracks[this.mixer.activetrack])}getNbClients(e){const t=c.default.countBy(this.clients.values(),(t=>t.isConcerned(e)));return c.default.isNil(t.true)?0:t.true}getConnectedInterfaces(){const e=c.default.filter(this.clients.values(),(e=>e.isConcerned(o.ClientType.INTERFACE)));return c.default.map(e,(e=>({user:e.user,id:e.id,mac:e.mac})))}queueUpdate(e){const t=JSON.parse(e),i=c.default.findIndex(this.queue.list,(e=>e.uuid==t.item.uuid));switch(t.action){case"add":this.queue.list.push(t.item),this.broadcast({command:o.ClientCommand.QUEUE,recipient:o.ClientType.INTERFACE,param:e});break;case"update":i>=0&&(this.queue.list.splice(i,1,t.item),this.broadcast({command:o.ClientCommand.QUEUE,recipient:o.ClientType.INTERFACE,param:e}));break;case"remove":this.queue.list.splice(i,1),this.broadcast({command:o.ClientCommand.QUEUE,recipient:o.ClientType.INTERFACE,param:e})}}getQueue(){return JSON.stringify(this.queue)}getVotes(){return JSON.stringify(this.votes.values())}register(e){const t=JSON.parse(e);t.points<0||0===t.votes.length||t.executed?this.votes.delete(t.uuid):this.votes.set(t.uuid,t),this.broadcast({command:o.ClientCommand.VOTE,recipient:o.ClientType.INTERFACE,param:e})}}t.PimixPlayer=d},484:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PimixScanner=void 0;const s=i(366),n=i(399);class a extends s.Client{constructor(e,t){super(e),this.scanner={connected:!1,since:null,nbsongs:0,queue:0,completed:0,failed:0},this.router=t,this.sd.socket.on(n.ScannerCommand.UPDATE,(e=>{const{nbsongs:t,since:i,queue:s,completed:n,failed:a}=JSON.parse(e);this.scanner.connected=!0,this.scanner.nbsongs=t,this.scanner.since=i,this.scanner.queue=s,this.scanner.completed=n,this.scanner.failed=a,this.broadcast()}))}geScannerDescription(){return JSON.stringify(this.scanner)}shutdown(){this.scanner.connected=!1,this.broadcast()}broadcast(){this.router.broadcast({command:n.ClientCommand.SCANNER,recipient:n.ClientType.INTERFACE,param:this.geScannerDescription()})}}t.PimixScanner=a},617:function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PimixWifi=void 0;const n=i(366),a=i(399),r=i(8),o=s(i(517));class c extends n.Client{constructor(e){super(e),this.wifi=new r.WIFIInterface,this.sd.socket.on(a.WIFICommand.SCAN,(e=>{const t=JSON.parse(e);this.wifi.connected=!0,this.wifi.interface=t.interface,this.wifi.ssid=t.ssid,this.wifi.networks=t.networks,o.default.isNil(this.pimixPlayer)||this.pimixPlayer.broadcastWIFI()})),this.sd.socket.on(a.WIFICommand.MESSAGE,(e=>{o.default.isNil(this.pimixPlayer)||this.pimixPlayer.broadcastWIFIMesssage(e)}))}attachPimixPlayer(e){this.pimixPlayer=e}detachPimixPlayer(){this.pimixPlayer=void 0}geWifiDescription(){return JSON.stringify(this.wifi)}shutdown(){this.wifi.connected=!1,this.wifi.interface="",this.wifi.ssid="",this.wifi.networks=[],o.default.isNil(this.pimixPlayer)||this.pimixPlayer.detachWIFIInterface(),this.pimixPlayer=void 0}sendPacket(e,t){this.sd.socket.emit(e.command,e.param,t)}}t.PimixWifi=c},551:function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Router=void 0;const n=s(i(299)),a=i(310),r=i(525),o=i(484),c=i(601),d=i(399),l=i(617),h=s(i(517));t.Router=class{constructor(e){this.clients=new n.default,this.servers=new n.default,this.wifiinterfaces=new n.default,console.log("> Router initialized ... waiting for incoming connections"),e.on("connection",(e=>{this.onconnect(e)}))}onconnect(e){var t;const i=new a.SocketDescriptor(this,e);switch(console.log(`Client connected ${i.toString()}`),i.type){case d.ClientType.PIMIXPLAYER:{const e=new r.PimixPlayer(i);this.servers.set(i.id,e);const t=this.wifiinterfaces.get(e.mac);h.default.isNil(t)||e.attachWIFIInterface(t),this.broadcast({command:d.ClientCommand.SERVERLIST,recipient:d.ClientType.INTERFACE,param:this.getServerListDescription()});break}case d.ClientType.SCANNER:this.scanner=new o.PimixScanner(i,this);break;case d.ClientType.INTERFACE:{const e=new c.WebInterface(i);this.clients.set(e.id,e),this.broadcast({command:d.ClientCommand.SCANNER,recipient:d.ClientType.INTERFACE,param:null===(t=this.scanner)||void 0===t?void 0:t.geScannerDescription()});break}case d.ClientType.WIFISCANNER:{const e=new l.PimixWifi(i);this.wifiinterfaces.set(i.mac,e);const t=this.servers.values(),s=h.default.find(t,(t=>t.mac===e.mac));h.default.isNil(s)||s.attachWIFIInterface(e);break}default:console.log("connect: invalid socket descriptor received ... ignoring ["+i.type.toString()+"]")}}ondisconnect(e){switch(console.log(`Client disconnected [${e.getClientType()} ${e.id}] from [${e.getRemoteAddress()}]`),e.type){case d.ClientType.PIMIXPLAYER:{const t=this.servers.get(e.id);h.default.isNil(t)||(this.servers.delete(e.id),t.shutdown(),this.broadcast({command:d.ClientCommand.SERVERLIST,recipient:d.ClientType.INTERFACE,param:this.getServerListDescription()}));break}case d.ClientType.SCANNER:h.default.isNil(this.scanner)||this.scanner.shutdown();break;case d.ClientType.WIFISCANNER:{const t=this.wifiinterfaces.get(e.id);h.default.isNil(t)||t.shutdown();break}case d.ClientType.INTERFACE:{const t=this.clients.get(e.id);h.default.isNil(t)||(h.default.isNil(t.pimixplayer)||t.pimixplayer.detach(t),this.clients.delete(t.id));break}default:console.log("disconnect: invalid socket descriptor received ... ignoring")}}map(e,t){const i=this.clients.get(e.id);if(h.default.isNil(i))console.log("map: unable to find the client reference");else{h.default.isNil(i.pimixplayer)||i.pimixplayer.detach(i);const e=this.servers.get(t);null!=e?(i.pimixplayer=e,e.attach(i)):console.log("map: unable to find the requested PimixPlayer")}}broadcast(e){this.clients.forEach((t=>{t.isConcerned(e.recipient)&&t.sendPacket(e)}))}getServerListDescription(){let e="";return this.servers.forEach((t=>{const i=t.getMixerDescription();h.default.isNil(i)||(e+=(e.length>0?",":"")+i)})),"["+e+"]"}}},310:function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SocketDescriptor=void 0;const n=i(399),a=s(i(517));class r{constructor(e,t){if(this._type=n.ClientType.UNKNOWN,this._mac="",this._router=e,this._socket=t,!a.default.isNil(t.handshake.query.binding)){const e=JSON.parse(`${t.handshake.query.binding}`);this._type=r.getClientType(e.component),this._mac=a.default.replace(e.ID,/-/g,":").toUpperCase();try{this._user=e.user}catch(e){console.log("Socket descriptor fail "+e)}}}toString(){var e;return` [${this.getClientType()} [${this.id}/${this.mac}] from [${this.getRemoteAddress()}] as [${null===(e=this.getUser())||void 0===e?void 0:e.login}]`}get id(){return this._socket.id}get mac(){return this._mac}get socket(){return this._socket}set socket(e){this._socket=e}get type(){return this._type}get router(){return this._router}getClientType(){return n.ClientType[this._type]}getRemoteAddress(){return this.socket.request.connection.remoteAddress}getUser(){return a.default.isNil(this._user)?{id:0,login:"anonymous",username:"anonymous"}:this._user}static getClientType(e){return"pimixplayer"===e?n.ClientType.PIMIXPLAYER:"interface"===e?n.ClientType.INTERFACE:"scanner"===e?n.ClientType.SCANNER:"wifiscanner"===e?n.ClientType.WIFISCANNER:n.ClientType.UNKNOWN}}t.SocketDescriptor=r},89:function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebClient=void 0;const n=i(366),a=i(399),r=s(i(517));class o extends n.Client{constructor(e){super(e),this.sd.socket.on(a.ServerCommand.MAP,(e=>{console.log("map request received",e),this.sd.router.map(this.sd,e)})),this.sd.socket.on(a.ServerCommand.COMMAND,(e=>{this.broadcast({command:a.ServerCommand.COMMAND,param:e})})),this.connected()}get pimixplayer(){return this.pimixPlayer}set pimixplayer(e){this.pimixPlayer=e,r.default.isNil(this.pimixPlayer)?(this.sendPacket({command:a.ClientCommand.DETACHED}),this.detached()):(this.sendPacket({command:a.ClientCommand.ATTACHED,param:this.pimixPlayer.getMixerDescription()}),this.attached())}isAttachedTo(e){return!r.default.isNil(this.pimixPlayer)&&this.pimixPlayer.id===e.id}connected(){}attached(){}detached(){}sendMixMeInitData(){}broadcast(e){r.default.isNil(this.pimixPlayer)||this.pimixPlayer.sendPacket(e,JSON.stringify(this.sd.getUser()))}sendPacket(e){this.sd.socket.emit(e.command,e.param)}}t.WebClient=o},601:function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebInterface=void 0;const n=i(89),a=i(399),r=s(i(517));class o extends n.WebClient{connected(){this.sendPacket({command:a.ClientCommand.SERVERLIST,param:this.sd.router.getServerListDescription()})}sendMixMeInitData(){this.attached()}attached(){if(!r.default.isNil(this.pimixplayer)){const e=this.pimixplayer.getMixerDescription();r.default.isNil(e)||this.sendPacket({command:a.ClientCommand.MIXER,param:e});const t=this.pimixplayer.getQueue();r.default.isNil(t)||this.sendPacket({command:a.ClientCommand.QUEUEINIT,param:t});const i=this.pimixplayer.getVotes();r.default.isNil(i)||this.sendPacket({command:a.ClientCommand.VOTESINIT,param:i});const s=this.pimixplayer.getQuizInitMessage();r.default.isNil(s)||this.sendPacket({command:a.ClientCommand.QUIZ,param:s})}}}t.WebInterface=o},299:e=>{e.exports=require("hashmap")},517:e=>{e.exports=require("lodash")},952:e=>{e.exports=require("socket.io")},685:e=>{e.exports=require("http")},147:e=>{e.exports=JSON.parse('{"name":"pimix-router","version":"2.0.0","description":"Websocket router, dispatch commands and events between PiMix Player and PiMix WebComponents (Controller,Playlist,Mixer,Quiz)","main":"index.js","scripts":{"router":"nodemon ./dist/router.js","build":"rm -rf dist && webpack","dev":"webpack --watch"},"repository":{"type":"git","url":"git+https://github.com/vbarrois/pimix-router.git"},"author":"Vincent Barrois","license":"ISC","bugs":{"url":"https://github.com/vbarrois/pimix-router/issues"},"homepage":"https://github.com/vbarrois/pimix-router#readme","dependencies":{"@types/hashmap":"^2.3.1","hashmap":"^2.4.0","lodash":"^4.17.21","socket.io":"^4.6.0","nodemon":"^2.0.20","@types/lodash":"^4.14.182","ts-loader":"^9.3.0","typescript":"^4.7.3","webpack":"^5.75.0","webpack-cli":"^5.0.1","webpack-node-externals":"^3.0.0"}}')}},t={};!function i(s){var n=t[s];if(void 0!==n)return n.exports;var a=t[s]={exports:{}};return e[s].call(a.exports,a,a.exports,i),a.exports}(341)})();