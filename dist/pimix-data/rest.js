(()=>{var e={417:(e,t,s)=>{"use strict";s.r(t),s.d(t,{addSongLog:()=>i,addSongUserLog:()=>a,updateSongLog:()=>o});var n=s(614);const i=e=>n.default.SongLog.create(e),o=e=>n.default.SongLog.update({listenratio:e.listenratio},{where:{id:e.id}}),a=e=>n.default.SongLogUser.create(e)},890:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("Artist",{name:t.STRING,state:t.BOOLEAN,spotifyId:t.STRING,popularity:t.INTEGER,followers:t.INTEGER});return s.associate=function(e){e.Artist.hasMany(e.ArtistRelated,{as:"ArtistRelations",foreignKey:"artist_id"})},s}},978:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("ArtistGenre",{artist_id:t.INTEGER,genre_id:t.INTEGER},{indexes:[{unique:!0,fields:["artist_id","genre_id"]}]});return s.associate=function(e){e.Artist.belongsToMany(e.Genre,{as:"Genres",through:{model:s,unique:!1},foreignKey:"artist_id"}),e.Genre.belongsToMany(e.Artist,{as:"Artists",through:{model:s,unique:!1},foreignKey:"genre_id"})},s}},953:e=>{"use strict";e.exports=(e,t)=>e.define("ArtistRelated",{artist_id:t.INTEGER,name:t.STRING,spotifyId:t.STRING,followers:t.INTEGER,popularity:t.INTEGER},{freezeTableName:!0})},936:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("Favorite",{songid:t.INTEGER,userid:t.INTEGER,public:t.INTEGER},{indexes:[{unique:!0,fields:["songid","userid"]}]});return s.associate=function(e){s.belongsTo(e.User,{foreignKey:"userid"}),s.belongsTo(e.Song,{foreignKey:"songid"})},s}},567:e=>{"use strict";e.exports=(e,t)=>e.define("Genre",{name:t.STRING,state:t.BOOLEAN})},614:(e,t,s)=>{"use strict";s.d(t,{default:()=>u,formatSequelizeErrors:()=>c});var n=s(517),i=s.n(n);const o=s(496),a=s(626).production,r={};let d;d=a.use_env_variable?new o(process.env[a.use_env_variable],a):new o(a.database,a.username,a.password,a);const l=s(956);l.keys().map(l).forEach((e=>{const t=e(d,o);r[t.name]=t})),Object.keys(r).forEach((e=>{r[e].associate&&r[e].associate(r)})),r.DB=d,r.sequelize=d;const u=r,c=e=>i().map(e,(e=>({path:e.path,key:e.validatorKey,message:e.message})))},941:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("Playlist",{name:{type:t.STRING,allowNull:!1,validate:{notNull:{msg:"validators.playlist.name.notnull"},isUnique(e){const t=this.id,n=this.userid;return s.findOne({where:{name:e,userid:n},transaction:this._validationTransaction}).then((e=>{if(null!==e&&e.id!==t)throw new Error("validators.playlist.name.unique")}))}}},userid:t.INTEGER,public:t.INTEGER});return s.associate=function(e){s.belongsTo(e.User,{foreignKey:"userid"})},s}},806:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("PlaylistSongs",{playlistid:t.INTEGER,index:{type:t.INTEGER,allowNull:!1,validate:{notNull:{msg:"validators.playlist.index.notnull"},isInt:{min:0,msg:"validators.playlist.index.format"}}},songid:{type:t.INTEGER,allowNull:!1,validate:{notNull:{msg:"validators.song.id.notnull"},isInt:{min:1,msg:"validators.song.id.format"},isUnique(e){const t=this.id,n=this.playlistid,i=this.songid;return s.findOne({where:{playlistid:n,songid:i},transaction:this._validationTransaction}).then((e=>{if(null!==e&&e.id!==t)throw new Error("validators.playlistsong.unique")}))}}}});return s.beforeValidate(((e,t)=>(t.transaction&&(e._validationTransaction=t.transaction),e))),s.afterValidate(((e,t)=>{delete e._validationTransaction})),s.associate=function(e){e.Song.belongsToMany(e.Playlist,{as:"Playlists",through:s,foreignKey:"songid"}),e.Playlist.belongsToMany(e.Song,{as:"Songs",through:s,foreignKey:"playlistid"})},s}},818:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("Song",{filepath:t.STRING,filename:t.STRING,title:t.STRING,album:t.STRING,year:t.INTEGER,bitrate:t.INTEGER,duration:t.DOUBLE,samplerate:t.INTEGER,size:t.INTEGER,ino:t.INTEGER,birth:t.DATE},{indexes:[{unique:!0,fields:["filepath","filename"]}]});return s.beforeValidate((e=>{e.filepath&&(e.filepath=e.filepath.replace(/\\/g,"/"))})),s.associate=function(e){s.hasMany(e.SongLog,{as:"SongLogs",foreignKey:"songid"}),s.hasMany(e.Favorite,{as:"Favorites",foreignKey:"songid"})},s}},673:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("SongArtist",{song_id:t.INTEGER,artist_id:t.INTEGER},{indexes:[{unique:!0,fields:["song_id","artist_id"]}]});return s.associate=function(e){e.Song.belongsToMany(e.Artist,{as:"Artists",through:{model:s,unique:!1},foreignKey:"song_id"}),e.Artist.belongsToMany(e.Song,{as:"Songs",through:{model:s,unique:!1},foreignKey:"artist_id"})},s}},829:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("SongGenre",{song_id:t.INTEGER,genre_id:t.INTEGER},{indexes:[{unique:!0,fields:["song_id","genre_id"]}]});return s.associate=function(e){e.Song.belongsToMany(e.Genre,{as:"Genres",through:{model:s,unique:!1},foreignKey:"song_id"}),e.Genre.belongsToMany(e.Song,{as:"Songs",through:{model:s,unique:!1},foreignKey:"genre_id"})},s}},735:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("SongLog",{sessionid:t.STRING(36),songid:t.INTEGER,listenratio:t.FLOAT,origin:t.STRING(10)});return s.associate=function(e){s.belongsTo(e.Song,{foreignKey:"songid"}),s.hasMany(e.SongLogUser,{as:"Votes",foreignKey:"logid"})},s}},498:e=>{"use strict";e.exports=(e,t)=>{const s=e.define("SongLogUser",{logid:t.INTEGER,userid:t.INTEGER,vote:t.INTEGER});return s.associate=function(e){s.belongsTo(e.SongLog,{foreignKey:"logid"}),s.belongsTo(e.User,{foreignKey:"userid"})},s}},729:(e,t,s)=>{"use strict";var n=s(432);e.exports=(e,t)=>{const s=e.define("User",{login:t.STRING,password:t.STRING,name:t.STRING,rights:t.INTEGER});return s.prototype.validPassword=function(e){return n.compareSync(e,this.password)},s.beforeCreate((e=>(void 0!==e.login&&(e.login=e.login.trim()),void 0!==e.name&&(e.name=e.name.trim()),e))),s.afterValidate((e=>{void 0!==e.password&&(e.password=n.hashSync(e.password,n.genSaltSync(10),null))})),s.associate=function(e){s.hasMany(e.Playlist,{as:"Playlists",foreignKey:"userid"}),s.hasMany(e.SongLogUser,{as:"Votes",foreignKey:"userid"})},s}},956:(e,t,s)=>{var n={"./artist.js":890,"./artistgenre.js":978,"./artistrelated.js":953,"./favorites.js":936,"./genre.js":567,"./playlist.js":941,"./playlistsong.js":806,"./song.js":818,"./songartist.js":673,"./songgenre.js":829,"./songlog.js":735,"./songloguser.js":498,"./user.js":729};function i(e){var t=o(e);return s(t)}function o(e){if(!s.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}i.keys=function(){return Object.keys(n)},i.resolve=o,e.exports=i,i.id=956},432:e=>{"use strict";e.exports=require("bcryptjs")},986:e=>{"use strict";e.exports=require("body-parser")},517:e=>{"use strict";e.exports=require("lodash")},496:e=>{"use strict";e.exports=require("sequelize")},626:e=>{"use strict";e.exports=JSON.parse('{"development":{"dialect":"sqlite","seederStorage":"sequelize","storage":"./pimix.sqlite3","logging":false},"production":{"dialect":"sqlite","storage":"/home/pimix.sqlite3","seederStorage":"sequelize","logging":false}}')},147:e=>{"use strict";e.exports=JSON.parse('{"name":"pimix-data","version":"1.0.8","description":"Pimix REST API from data management","main":"index.js","scripts":{"scanner":"nodemon ./dist/scanner.js","cluster":"nodemon ./dist/pimix-cluster.js","data":"nodemon ./dist/rest.js","wifi":"nodemon ./dist/wifi.js","test":"echo \\"Error: no test specified\\" && exit 1","lint":"eslint \\"src/**/*.js\\" --ignore-pattern node_modules/ ","build":"rm -rf dist && webpack","start":"yarn concurrently -k -n \\"data,scanner,wifi\\" -p \\"[{name}]\\" -c \\"yellow,green,blue\\" \\"yarn data\\" \\"yarn scanner\\" \\"yarn wifi\\""},"repository":{"type":"git","url":"git+https://github.com/vbarrois/pimix-data.git"},"author":"Vincent Barrois","license":"ISC","bugs":{"url":"https://github.com/vbarrois/pimix-data/issues"},"homepage":"https://github.com/vbarrois/pimix-data#readme","dependencies":{"@babel/core":"^7.9.6","@babel/preset-env":"^7.9.6","babel-loader":"^8.1.0","bcryptjs":"^2.4.3","bull":"^3.11.0","chatgpt":"^4.7.2","child_process":"^1.0.2","chokidar":"^3.5.3","concurrently":"^5.1.0","copy-webpack-plugin":"^10.2.0","eslint":"^6.6.0","eslint-config-standard":"^14.1.0","eslint-loader":"^4.0.2","eslint-plugin-import":"^2.18.2","eslint-plugin-node":"^10.0.0","eslint-plugin-promise":"^4.2.1","eslint-plugin-standard":"^4.0.1","express":"^4.17.1","getmac":"^5.16.0","jimp":"^0.10.0","jsonwebtoken":"^8.5.1","moment":"^2.24.0","music-metadata":"^7.13.3","nodemon":"^1.19.4","qrcode":"^1.5.1","recluster":"^1.0.0","sequelize":"^5.21.1","sequelize-cli":"^6.6.0","socket.io-client":"^4.4.1","spotify-web-api-node":"^5.0.2","sqlite3":"^5.0.8","uuid":"^9.0.0","webpack":"^5.75.0","webpack-cli":"^5.0.1","webpack-dev-middleware":"^6.0.1","webpack-hot-middleware":"^2.25.3","webpack-node-externals":"^3.0.0"}}')}},t={};function s(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,s),o.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";const e=require("path");var t=s.n(e);const n=require("express");var i=s.n(n),o=s(614),a=s(496),r=s.n(a),d=s(517),l=s.n(d);const u=i().Router();u.post("/api/login",((e,t)=>{o.default.User.findOne({where:r().where(r().fn("lower",r().col("login")),r().fn("lower",e.body.login))}).then((s=>s?s.validPassword(e.body.password)?t.status(200).send({connected:!0,user:c(s)}):t.status(200).send({connected:!1,message:"Incorrect password."}):t.status(200).send({connected:!1,message:"Incorrect login."})))})),u.post("/api/pseudo",((e,t)=>{o.default.User.findOrCreate({where:r().where(r().fn("lower",r().col("login")),r().fn("lower",e.body.login)),defaults:{login:e.body.login,rights:0}}).then((e=>{const s=c(e[0].dataValues);return s?t.status(200).send({connected:!0,user:s}):t.status(200).send({connected:!1,message:"Incorrect pseudo."})}))})),u.get("/api/userstats/:userid",((e,t)=>{o.default.User.findOne({where:{id:e.params.userid},include:[{model:o.default.Playlist,attributes:["id","name"],as:"Playlists"},{model:o.default.SongLogUser,include:[{model:o.default.SongLog,attributes:["sessionid","songid"],as:"SongLog"}],attributes:["id","logid","vote"],as:"Votes"}]}).then((e=>{if(e){const s=l().map(e?.Votes,(e=>({vote:e.vote,sessionid:e.SongLog?.sessionid,songid:e.SongLog?.songid}))),n={id:e.id,login:e.login,Votes:l().map(l().groupBy(s,(e=>e.sessionid)),(e=>({count:e.length,points:l().sumBy(e,(e=>e.vote)),created:l().countBy(e,(e=>2===e.vote)).true,followed:l().countBy(e,(e=>1===e.vote)).true,items:e}))),Playlists:{items:e.Playlists,count:e.Playlists.length},countVotes:e.Votes.length};return t.status(200).send(n)}return t.status(200).end()}))})),u.get("/api/sessionstats/:sessionid",((e,t)=>{o.default.SongLog.findAll({where:{sessionid:e.params.sessionid},attributes:["songid","listenratio","origin","createdAt"],include:[{model:o.default.SongLogUser,attributes:["userid","vote"],as:"Votes"}]}).then((e=>{if(e){const s=l().groupBy(e,(e=>e.origin));return t.status(200).send(s)}return t.status(200).end()}))}));const c=e=>({id:e.id,login:e.login,username:e.name,rights:e.rights}),p=u,g=(i().Router(),{attributes:["id","filepath","filename","title","album","year","duration","bitrate","birth","ino","size","samplerate","createdAt","updatedAt"],include:[{model:o.default.Artist,as:"Artists",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:o.default.Genre,as:"Genres",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:o.default.Playlist,attributes:["id","name"],as:"Playlists"},{model:o.default.Favorite,attributes:["id","userid"],as:"Favorites",required:!1},{model:o.default.SongLog,as:"SongLogs",attributes:[],include:[{model:o.default.SongLogUser,as:"Votes",attributes:[]}]}]}),S="(AVG(SL.listenratio)*2-.4)*(1-1.0/(COUNT(SL.id)+2))",y=(r().fn("MAX",r().col("SongLogs.createdAt")),r().fn("COUNT",r().col("SongLogs.id")),r().fn("SUM",r().col("SongLogs.Votes.vote")),r().fn("AVG",r().col("SongLogs.listenratio")),o.default.SongLog,o.default.SongLogUser,(e,t=!0)=>(C(e),`\n    SELECT\n      SONGSTATS.id,\n      SONGSTATS.filename,\n      SONGSTATS.title,\n      SONGSTATS.album,\n      SONGSTATS.filepath,\n      SONGSTATS.duration,\n      SONGSTATS.lastplaymin,\n      SONGSTATS.lastplaydate,\n      SONGSTATS.playcount,\n      SONGSTATS.listenratio,\n      SONGSTATS.votepoints,\n      SONGSTATS.likescore,\n      SONGSTATS.birthdate,\n      SONGSTATS.year,\n      ${t?"NULL":"A.id"} AS artistid,\n      ${t?"MAX(A.followers)":"A.followers"} AS followers,\n      ${t?"MAX(A.popularity)":"A.popularity"} AS popularity,\n      SONGSTATS.likecount,\n      SONGSTATS.genreplaycount,\n      SONGSTATS.genrelistenratio,\n      SONGSTATS.genrevotepoints,\n      SONGSTATS.genrelikescore\n    FROM (\n      ${m(e)}\n    ) SONGSTATS, SongArtists SA\n    LEFT JOIN Artists A ON A.id = SA.artist_id\n    WHERE SA.song_id = SONGSTATS.id\n    ${f(e)}\n    ${E(e)}\n    ${t?"GROUP BY SONGSTATS.id":""}\n    ${A(e)}\n    ${N(e)}\n  `)),h=e=>{let t="";return"artistrelated"!==e.sortKey||l().isNil(e.activeSong)?!l().isNil(e.artistids)&&e.artistids.length>0?e.artistids.join(","):"":(t=`SELECT\n      A.id\n      FROM Songs S, SongArtists SA\n      LEFT JOIN ArtistRelated AR, Artists A ON AR.artist_id = SA.artist_id AND A.spotifyId = AR.spotifyId\n      WHERE S.id = ${e.activeSong.id}\n      AND SA.song_id = S.id`,t)},m=e=>`\n    SELECT \n      S.id,\n      S.filename,\n      S.filepath,\n      S.title,\n      S.album,\n      S.duration,\n      A.name,\n      (JULIANDAY(datetime('now')) - JULIANDAY(MAX(SL.createdAt))) * 24 * 60 AS lastplaymin,\n      MAX(SL.createdAt) AS lastplaydate,\n      COUNT(SL.id) AS playcount, \n      AVG(SL.listenratio) AS listenratio, \n      SUM(SLU.vote) as votepoints, \n      ${S} AS likescore,\n      S.birth AS birthdate,\n      S.year AS year,\n      COUNT(DISTINCT(F.id)) AS likecount,\n      GENRES_STATS.playcount AS genreplaycount,\n      GENRES_STATS.listenratio AS genrelistenratio,\n      GENRES_STATS.votepoints AS genrevotepoints,\n      GENRES_STATS.likescore AS genrelikescore,\n      ${!l().isNil(e.activeSong)&&e.activeSong.year>0?`ABS(S.year - ${e.activeSong.year}) AS yeardelta`:"0 AS yeardelta"}\n    FROM Songs S, SongGenres SG, Genres G, SongArtists SA, Artists A\n    LEFT JOIN Favorites F ON F.songid = S.id ${l().isNil(e.userids)?"":`AND F.userid in (${e.userids.join(",")})`}\n    LEFT JOIN SongLogs SL ON SL.songid = S.id\n    LEFT JOIN SongLogUsers SLU ON SLU.logid = SL.id\n    LEFT JOIN (${T()}) GENRES_STATS ON GENRES_STATS.genre_id = SG.genre_id\n    WHERE SG.song_id = S.id\n    AND SG.genre_id = G.id\n    AND SA.song_id = S.id\n    AND SA.artist_id = A.id\n    ${l().isNil(e.removeDisabledGenres)||1!==e.removeDisabledGenres?"":"AND G.state = 1"}\n    ${!l().isNil(e.songids)&&e.songids.length>0?`AND S.id IN (${e.songids.join(",")})`:""}\n    ${!l().isNil(e.excludesongids)&&e.excludesongids.length>0?`AND S.id NOT IN (${e.excludesongids.join(",")})`:""}\n    ${!l().isNil(e.genreids)&&e.genreids.length>0?`AND SG.genre_id IN (${e.genreids.join(",")})`:""}\n    ${h(e).length>0?`AND SA.artist_id IN (${h(e)})`:""}\n    ${!l().isNil(l().get(e,"period.from"))&&e.period.from>0?`AND S.year >= ${e.period.from}`:""}\n    ${!l().isNil(l().get(e,"period.to"))&&e.period.to>0?`AND S.year <= ${e.period.to}`:""}\n    ${!l().isNil(e.sincehours)&&parseInt(e.sincehours)>0?`AND (JULIANDAY(datetime('now')) - JULIANDAY(SL.createdAt)) * 24 < ${e.sincehours}`:""}\n    GROUP BY S.id`,f=e=>{const t=_[e.sortKey];return l().isNil(l().get(t,"condition"))?"":l().map(t.condition,(e=>`AND ${e}`))},A=e=>{const t=_[e.sortKey];return l().isNil(l().get(t,"order"))?"":`ORDER BY ${t.order.join(", ")}`},T=()=>`\n    SELECT\n      SG.genre_id,\n      COUNT(SL.id) AS playcount, \n      AVG(SL.listenratio) AS listenratio, \n      SUM(SLU.vote) as votepoints, \n      ${S} AS likescore\n    FROM Songs S, SongGenres SG\n    LEFT JOIN SongLogs SL ON SL.songid = S.id\n    LEFT JOIN SongLogUsers SLU ON SLU.logid = SL.id\n    WHERE SG.song_id = S.id\n    GROUP by SG.genre_id`,E=e=>!l().isNil(e.notplayedsinceminutes)&&e.notplayedsinceminutes>0?`\n      AND SONGSTATS.id NOT IN (\n        SELECT songid FROM SongLogs\n        WHERE (JULIANDAY(datetime('now')) - JULIANDAY(createdAt)) * 24 * 60 < ${e.notplayedsinceminutes}\n      )\n    `:"",N=e=>!l().isNil(e.limit)&&parseInt(e.limit)>0?`LIMIT 0, ${e.limit}`:"",b=(e,t)=>l().isNil(t.shake)||!0!==t.shake?e:`\n    SELECT * FROM (${e}) ORDER BY RANDOM()`,_={shuffle:{order:["RANDOM()"]},favorites:{condition:["likecount > 0"],order:["likecount DESC","playcount DESC","birthdate DESC"]},mostplayed:{condition:["playcount > 0"],order:["playcount DESC","birthdate DESC"]},lessplayed:{condition:["playcount > 0"],order:["playcount ASC","birthdate DESC"]},bestlisten:{condition:["listenratio > 0"],order:["listenratio DESC","playcount DESC","birthdate DESC"]},poorlisten:{condition:["listenratio > 0"],order:["listenratio ASC","playcount ASC","birthdate DESC"]},lastadded:{order:["birthdate DESC"]},firstadded:{order:["birthdate ASC"]},mostrecent:{order:["year DESC"]},oldest:{order:["year ASC"]},bestvotes:{order:["votepoints DESC","playcount DESC","birthdate DESC"]},followers:{order:["followers DESC","playcount DESC","birthdate DESC"]},popularity:{order:["popularity DESC","playcount DESC","birthdate DESC"]},safelike:{order:["likescore DESC","yeardelta ASC","birthdate DESC"]},discover:{condition:["genrelikescore > 1"],order:["playcount ASC","yeardelta ASC","birthdate DESC"]},near:{order:["yeardelta ASC","birthdate DESC"]},probablynotliked:{condition:["genrelikescore <= 1"],order:["playcount ASC","yeardelta ASC","birthdate DESC"]},forgot:{order:["playcount ASC","listenratio ASC","birthdate DESC"]},artistrelated:{order:["yeardelta ASC","playcount DESC","listenratio DESC","birthdate DESC"]}},C=e=>{console.log("------------------------------------------------------------------------------------"),console.log(`Request song library mode [${e.sortKey}]`),!l().isNil(e.keywords)&&e.keywords.length>0&&console.log(`  * Recherche des mots clés: [${e.keywords}]`),!l().isNil(e.notplayedsinceminutes)&&e.notplayedsinceminutes>0&&console.log(`  * Pas écouté depuis ${e.notplayedsinceminutes} minutes`),l().isNil(l().get(e,"period.from"))||console.log(`  * après ${e.period.from}`),l().isNil(l().get(e,"period.to"))||console.log(`  * avant ${e.period.from}`),!l().isNil(e.songids)&&e.songids.length>0&&console.log(`  * Uniquement les titres selectionés [${e.songids.join(",")}]`),!l().isNil(e.genreids)&&e.genreids.length>0&&console.log(`  * Uniquement les genres selectionés [${e.genreids.join(",")}]`),!l().isNil(e.artistids)&&e.artistids.length>0&&console.log(`  * Uniquement les artistes selectionés [${e.artistids.join(",")}]`),l().isNil(e.removeDisabledGenres)||1!==e.removeDisabledGenres||console.log("  * Uniquement les genres actifs"),!l().isNil(e.userids)&&e.userids.length>0&&console.log(`  * Mode mes favoris avec les users [${e.userids.join(",")}]`),!l().isNil(e.activeSong)&&e.activeSong.year>0&&console.log(`  * Titre actif ${e.activeSong.filename}; année ${e.activeSong.year}`),!l().isNil(e.sincehours)&&parseInt(e.sincehours)>0&&console.log(`  * Statistiques calculées sur les ${e.sincehours} dernières heures`),!l().isNil(e.limit)&&parseInt(e.limit)>0&&console.log(`  * Limiter les résultats aux ${e.limit} premiers`),l().isNil(e.shake)||!0!==e.shake||console.log("  * Tirage au sort des résultats"),console.log("------------------------------------------------------------------------------------")},G=require("jimp");var O=s.n(G);const L=i().Router(),R=(e=null)=>`SELECT \n      G.id, \n      G.name, \n      G.state, \n      COUNT(DISTINCT(SG.song_id)) AS songscount, \n      MIN(S.year) AS yearfrom, \n      MAX(S.year) AS yearto, \n      COUNT(SL.id) AS playcount, \n      COUNT(DISTINCT(F.id)) AS likecount, \n      AVG(SL.listenratio) AS listenratio, \n      MAX(SL.createdAt) AS lastplayed,\n      ${S} AS likescore\n    FROM SongGenres SG, Genres G, Songs S \n    LEFT JOIN Favorites F ON F.songid = S.id \n    LEFT JOIN SongLogs SL ON SL.songid = S.id \n    LEFT JOIN SongLogUsers SLU ON SLU.logid = SL.id \n    WHERE SG.genre_id = G.id \n    AND SG.song_id = S.id \n    ${!l().isNil(e)&&e.length>0?`AND G.id IN (${e.join(",")})`:""}\n    GROUP BY G.id`;L.get("/api/genres",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.DB.query(R(),{type:r().QueryTypes.SELECT}).then((e=>{const s=l().map(e,(e=>I(e)));t.status(200).json(s)})).catch((e=>{t.status(500).send(e)}))})),L.get("/api/genre/:id",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.DB.query(R([e.params.id]),{type:r().QueryTypes.SELECT}).then((e=>{t.status(200).json(I(e[0]))})).catch((e=>{t.status(500).send(e)}))})),L.post("/api/genre/byids",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.DB.query(R(e.body),{type:r().QueryTypes.SELECT}).then((e=>{t.status(200).json(l().map(e,(e=>I(e))))})).catch((e=>{t.status(500).send(e)}))})),L.post("/api/genres/state",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body.genreid,n="UPDATE Genres SET state = "+e.body.state+" WHERE id = "+s;o.default.DB.query(n,{type:r().QueryTypes.UPDATE}).then((()=>{t.status(200).end()})).catch((e=>{t.status(500).send(e)}))})),L.post("/api/genres/switch",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body.genreid,n=e.body.condition,i="UPDATE Genres SET state = "+("only"===n?0:1),a="UPDATE Genres SET state = "+("only"===n?1:0)+" WHERE id = "+s;o.default.DB.query(i,{type:r().QueryTypes.UPDATE}).then((()=>o.default.DB.query(a,{type:r().QueryTypes.UPDATE}))).then((()=>{t.status(200).end()})).catch((e=>{console.log(e),t.status(500).send(e)}))}));const I=e=>({id:e.id,name:e.name,state:parseInt(e.state),songscount:parseInt(e.songscount),yearfrom:parseInt(e.yearfrom),yearto:parseInt(e.yearto),playcount:parseInt(e.playcount||0),listenratio:parseFloat(e.listenratio||0),likescore:parseFloat(e.likescore||0),likecount:parseInt(e.likecount||0),lastplayed:e.lastplayed,createdAt:e.createdAt,updatedAt:e.updatedAt}),v=L,D=i().Router(),w=(e,t=!1)=>t&&!l().isNil(e.length>0)?`SELECT\n      A.id\n      FROM ArtistRelated AR, Artists A ON AR.artist_id in (${e.join(",")}) AND A.spotifyId = AR.spotifyId`:!l().isNil(e)&&e.length>0?e.join(","):"",U=(e=null,t=!1)=>`SELECT\n      A.id,\n      A.name,\n      A.spotifyId,\n      A.followers,\n      A.popularity,\n      A.state,\n      COUNT(DISTINCT(SA.song_id)) AS songscount,\n      MIN(S.year) AS yearfrom,\n      MAX(S.year) AS yearto,\n      COUNT(DISTINCT(F.id)) AS likecount, \n      AVG(SL.listenratio) AS listenratio,\n      SUM(SLU.vote) AS votepoints,\n      COUNT(SL.id) AS playcount,\n      ${S} AS likescore\n    FROM SongArtists SA, Artists A, Songs S\n    LEFT JOIN Favorites F ON F.songid = S.id \n    LEFT OUTER JOIN SongLogs SL ON SL.songid = S.id\n    LEFT OUTER JOIN SongLogUsers SLU ON SLU.logid = SL.id\n    WHERE SA.artist_id = A.id\n    AND SA.song_id = S.id\n    ${w(e,t).length>0?`AND A.id IN (${w(e,t)})`:""}\n    GROUP BY A.id`;D.get("/api/artists",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.DB.query(U(),{type:r().QueryTypes.SELECT}).then((e=>{t.status(200).json(e)})).catch((e=>{t.status(500).send(e)}))})),D.get("/api/artist/:id",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),Promise.all([o.default.DB.query(U([e.params.id]),{type:r().QueryTypes.SELECT}),o.default.DB.query(U([e.params.id],!0),{type:r().QueryTypes.SELECT})]).then((([e,s])=>{t.status(200).json({artist:q(e[0]),related:l().map(s,(e=>q(e)))})})).catch((e=>{console.log(e),t.status(500).send(e)}))})),D.post("/api/artist/byids",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.DB.query(U(e.body),{type:r().QueryTypes.SELECT}).then((e=>{t.status(200).json(e)})).catch((e=>{t.status(500).send(e)}))})),D.post("/api/artists/state",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body.artistid,n="UPDATE Artists SET state = "+e.body.state+" WHERE id = "+s;o.default.DB.query(n,{type:r().QueryTypes.UPDATE}).then((()=>{t.status(200).end()})).catch((e=>{t.status(500).send(e)}))})),D.post("/api/artists/switch",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body.artistid,n=e.body.condition,i="UPDATE Artists SET state = "+("only"===n?0:1),a="UPDATE Artists SET state = "+("only"===n?1:0)+" WHERE id = "+s;o.default.DB.query(i,{type:r().QueryTypes.UPDATE}).then((()=>o.default.DB.query(a,{type:r().QueryTypes.UPDATE}))).then((()=>{t.status(200).end()})).catch((e=>{console.log(e),t.status(500).send(e)}))}));const q=e=>({id:e.id,name:e.name,state:e.state,spotifyId:e.spotifyId,popularity:e.popularity,followers:e.followers,playcount:e.playcount,listenratio:e.listenratio,likescore:e.likescore,likecount:parseInt(e.likecount||0),songscount:e.songscount,createdAt:e.createdAt,updatedAt:e.updatedAt}),j=D,P=require("spotify-web-api-node");var $=new(s.n(P)())({clientId:"b5bddd99c0e5478882a08dd12b3f8198",clientSecret:"98f938ee4c0a4bbfb6c91d164d5922a8",redirectUri:"http://localhost/spotify"});const k=i().Router(),M=process.env.COVER_FOLDER||"/home/covers";function x(e,s){return new Promise(((n,i)=>{o.default.Song.findOne({where:{id:e}}).then((e=>{const o=M+(s?"/thumbs/":"/")+t().parse(e.filename).name+".jpg";O().read(o).then((e=>{e.getBuffer(O().MIME_JPEG,((e,t)=>{e?i(e):n(t)}))})).catch((e=>{i(e)}))})).catch((e=>{i(e)}))}))}k.post("/api/songs/fromids",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=l().map(e.body.ids.split(","),(e=>parseInt(e)));o.default.Song.findAll({where:{id:s}}).then((e=>{const n=l().sortBy(l().map(e,(e=>({index:l().indexOf(s,e.id),song:F(e)}))),["index"],["asc"]);t.send(l().map(n,(e=>({song:e.song}))))})).catch((e=>(console.log(`There was an error querying songs from ids ${s}`,JSON.stringify(e)),t.status(500).send(e))))})),k.post("/api/songs/all",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body;o.default.DB.query(b(y(s),s),{type:a.Sequelize.QueryTypes.SELECT}).then((e=>{t.send(e)})).catch((e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e))))})),k.post("/api/song/info/:id",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),Promise.all([o.default.Song.findOne({where:{id:e.params.id},...g}),o.default.DB.query(y({songids:[e.params.id]}),{type:a.Sequelize.QueryTypes.SELECT})]).then((e=>{const s=F({...e[0].dataValues,...e[1][0]});t.send(s)})).catch((s=>(console.log(`There was an error querying song ${e.params.id}`,JSON.stringify(s)),t.status(500).send(s))))})),k.get("/api/song/thumb/:id",((e,t)=>{x(e.params.id,!0).then((e=>{t.set("Content-Type",O().MIME_JPEG),t.status(200).send(e)})).catch((e=>{console.log(e),t.status(500).end()}))})),k.get("/api/song/cover/:id",((e,t)=>{x(e.params.id,!1).then((e=>{t.set("Content-Type",O().MIME_JPEG),t.status(200).send(e)})).catch((e=>{console.log(e.toString()),t.status(500).end()}))})),k.get("/api/songs/last/:count",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.Song.findAll({limit:e.params.count,order:[["createdAt","desc"]],include:[{model:o.default.Genre,as:"Genres"},{model:o.default.Artist,as:"Artists"},{model:o.default.Playlist,attributes:["id","name"],as:"Playlists"}]}).then((e=>t.send(e))).catch((s=>(console.log(`There was an error querying last songs (${e.params.count})`,s.toString()),t.status(500).send(s))))})),k.get("/api/songs/genre/:genre",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.Song.findAll({where:{"$Genres.id$":e.params.genre.split(",")},include:[{model:o.default.Genre,as:"Genres",required:!1},{model:o.default.Artist,as:"Artists",required:!1},{model:o.default.Playlist,attributes:["id","name"],as:"Playlists"}]}).then((e=>t.send(e))).catch((e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e))))})),k.get("/api/songs/artist/:artistids",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.Song.findAll({where:{"$Artists.id$":e.params.artistids.split(",")},include:[{model:o.default.Genre,as:"Genres",required:!1},{model:o.default.Artist,as:"Artists",required:!1},{model:o.default.Playlist,attributes:["id","name"],as:"Playlists"}]}).then((e=>t.send(e))).catch((e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e))))})),k.get("/api/spotify/artist/:mode/:param",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),console.log("spotify",e.params.name);const s=[];switch(e.params.mode){case"byid":s.push((i=e.params.param,new Promise(((e,t)=>$.clientCredentialsGrant().then((t=>{$.setAccessToken(t.body.access_token),e($.getArtist(i))})).catch(t)))));break;case"related":s.push((e=>new Promise(((t,s)=>$.clientCredentialsGrant().then((s=>{$.setAccessToken(s.body.access_token),t($.getArtistRelatedArtists(e))})).catch(s))))(e.params.param));break;default:s.push((n=e.params.param,new Promise(((e,t)=>(console.log("spotify request",n),$.clientCredentialsGrant().then((t=>{$.setAccessToken(t.body.access_token),e($.searchArtists(n))})).catch(t))))))}var n,i;Promise.all(s).then((e=>t.status(200).send(e[0]))).catch((e=>t.status(500).end(e)))}));const F=e=>({id:e.id,filepath:e.filepath,filename:e.filename,title:e.title,album:e.album,year:e.year,bitrate:e.bitrate,duration:e.duration,samplerate:e.samplerate,size:e.size,ino:e.ino,birth:e.birth,createdAt:e.createdAt,updatedAt:e.updatedAt,Genres:l().map(e.Genres,(e=>I(e))),Artists:l().map(e.Artists,(e=>q(e))),Playlists:l().map(e.Playlists,(e=>({id:e.id,name:e.name}))),Favorites:l().map(e.Favorites,(e=>({id:e.id,userid:e.userid}))),playcount:e.playcount,votepoints:e.votepoints,lastplayed:e.lastplayed,listenratio:e.listenratio,likecount:e.likecount,likescore:l().round(e.likescore,2)}),B=e=>new Promise(((t,s)=>o.default.Song.findOne({where:{id:e},...g}).then((e=>{t(e)})).catch(s))),H=k,K=i().Router();K.get("/api/genius/list",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=l().map(l().keys(_),(e=>({key:e,title:`genius.${e}`})));return t.status(200).send(s)})),K.post("/api/genius/next",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");let s=e.body.nextmode;const n=e.body.notplayedsince,i=e.body.current,a=e.body.userids;let d=((e,t=240,s=[],n=4)=>({sortKey:e,notplayedsinceminutes:t,userids:s,removeDisabledGenres:1,shake:!0,limit:n}))(s,n,a);l().isNil(i)||(d=l().merge(d,{activeSong:i})),o.default.DB.query(b(y(d),d),{type:r().QueryTypes.SELECT}).then((e=>e.length>0?e:(s="shuffle",o.default.DB.query(b(y({sortKey:s,userids:d.userids,limit:1}),d),{type:r().QueryTypes.SELECT})))).then((e=>B(e[0].id))).then((e=>t.status(200).send({origin:s,song:e}))).catch((e=>(console.log(`There was an error querying ${s} next`,d),t.status(500).send(e))))}));const J=K,V=e=>({id:e.id,filepath:e.filepath,filename:e.filename,title:e.title,album:e.album,year:e.year,bitrate:e.bitrate,duration:e.duration,samplerate:e.samplerate,size:e.size,ino:e.ino,birth:e.birth,createdAt:e.createdAt,updatedAt:e.updatedAt}),Q=require("qrcode");var z=s.n(Q);const Y=require("os");var W=s.n(Y);const X=s(417),Z=i().Router();Z.get("/api/qrcode/:port",((e,t)=>{const s=ee()[0];l().isNil(s)?t.end():z().toFileStream(t,`http://${s.address}${e.params.port?`:${e.params.port}`:""}`)})),Z.get("/api/network",((e,t)=>{t.status(200).send(ee())}));const ee=(e="IPV4",t=!0)=>{const s=W().networkInterfaces();return l().flatten(l().filter(l().map(s,(s=>l().map(l().filter(s,(s=>s.family.toString().toUpperCase()===e&&s.internal===!t&&"255.255.255.0"===s.netmask)),(e=>({address:e.address}))))),(e=>e.length>0)))};Z.post("/api/log/songplayed",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body.item,n=e.body.sessionid,i=e.body.item.origin;null!==s&&null!==s.song&&X.addSongLog({sessionid:n,songid:s.song.id,origin:i}).then((e=>{const t=e.dataValues,n=[];return l().forEach(s.votes,(e=>{const s={logid:t.id,userid:e.userid,vote:e.points};n.push(X.addSongUserLog(s))})),new Promise(((e,s)=>{Promise.all(n).then(e(t)).catch(s)}))})).then((e=>t.status(200).send(e))).catch((e=>(console.log("Cannot create song logs",JSON.stringify(e)),t.status(500).send(e))))})),Z.post("/api/log/songcomplete",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body.id,n=e.body.listenratio;X.updateSongLog({id:s,listenratio:n}).then((()=>t.status(200).end())).catch((e=>(console.log("Cannot update song logs",JSON.stringify(e)),t.status(500).send(e))))})),Z.get("/api/log/mostplayed/:count",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.SongLog.findAll({group:["songid"],attributes:["songid",[r().fn("COUNT","songid"),"PlayCount"]],limit:e.params.count,order:[[r().literal("PlayCount"),"desc"]],include:[{model:o.default.Song,as:"Song"}]}).then((e=>{const s=l().map(e,(e=>({count:e.dataValues.PlayCount,...V(e.Song)})));t.status(200).send(s)})).catch((s=>(console.log(`There was an error querying most played songs (${e.params.count})`,s.toString()),t.status(500).send(s))))})),Z.get("/api/log/mostswipped/:count",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.SongLog.findAll({group:["songid"],attributes:["songid",[r().fn("AVG",r().col("listenratio")),"PlayRatio"]],limit:e.params.count,where:{listenratio:{[a.Op.ne]:null}},order:[[r().literal("PlayRatio"),"asc"]],include:[{model:o.default.Song,as:"Song"}]}).then((e=>{const s=l().map(e,(e=>({playratio:e.dataValues.PlayRatio,...V(e.Song)})));t.status(200).send(s)})).catch((s=>(console.log(`There was an error querying most swipped songs (${e.params.count})`,s.toString()),t.status(500).send(s))))})),Z.get("/api/log/mostlistened/:count",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.SongLog.findAll({group:["songid"],attributes:["songid",[r().fn("AVG",r().col("listenratio")),"PlayRatio"]],limit:e.params.count,where:{listenratio:{[a.Op.ne]:null}},order:[[r().literal("PlayRatio"),"desc"]],include:[{model:o.default.Song,as:"Song"}]}).then((e=>{const s=l().map(e,(e=>({playratio:e.dataValues.PlayRatio,...V(e.Song)})));t.status(200).send(s)})).catch((s=>(console.log(`There was an error querying most listened songs (${e.params.count})`,s.toString()),t.status(500).send(s))))})),Z.get("/api/log/lastplayed/:count",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.SongLog.findAll({limit:e.params.count,order:[["createdAt","desc"]],include:[{model:o.default.Song,as:"Song"}]}).then((e=>{const s=l().map(e,(e=>({playedDate:e.dataValues.createdAt,...V(e.Song)})));t.status(200).send(s)})).catch((s=>(console.log(`There was an error querying last played songs (${e.params.count})`,s.toString()),t.status(500).send(s))))}));const te=Z,se=i().Router();se.post("/api/search",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body.keywords,n=l().filter(l().map(s.replace(/\s\s+/g," ").trim().split(" "),(e=>e.replace("'","''").replace("+"," "))),(e=>e.length>2));console.debug(`Searching for [${n}]`);const i=[];i.push(o.default.DB.query(ne(n),{type:r().QueryTypes.SELECT})),i.push(o.default.DB.query(ie(n),{type:r().QueryTypes.SELECT})),i.push(o.default.DB.query(oe(n),{type:r().QueryTypes.SELECT})),Promise.all(i).then((([e,s,i])=>{console.log(` = results: ${i.length} tracks, ${e.length} artists, ${s.length} genres`),t.send({keywords:n,songs:l().orderBy(i,["precision","artistcount","genrecount"],["desc","desc","desc"]),artists:e,genres:s})})).catch((e=>(console.log(`There was an error querying search: ${s}`,JSON.stringify(e)),t.status(500).send(e))))}));const ne=e=>`\n    SELECT\n      SUM(SEARCH.precision) as precision,\n      SEARCH.id,\n      SEARCH.name\n    FROM\n      (${l().map(e,(e=>`SELECT \n      A.id AS id, \n      CASE\n        WHEN UPPER(A.name) = '${e.toUpperCase()}' THEN 2\n        ELSE 1\n      END precision,\n      A.name\n    FROM Artists A\n    WHERE \n      A.name LIKE '%${e}%'\n    GROUP BY A.id`)).join(" UNION ALL ")}) SEARCH\n    GROUP BY SEARCH.id\n  `,ie=e=>`\n    SELECT\n      SUM(SEARCH.precision) as precision,\n      SEARCH.id,\n      SEARCH.name\n    FROM\n      (${l().map(e,(e=>`SELECT \n      G.id AS id, \n      CASE\n        WHEN UPPER(G.name) = '${e.toUpperCase()}' THEN 2\n        ELSE 1\n      END precision,\n      G.name\n    FROM Genres G, SongGenres SG\n    WHERE \n      SG.genre_id = G.id\n      AND G.name LIKE '%${e}%'\n    GROUP BY G.id`)).join(" UNION ALL ")}) SEARCH\n    GROUP BY SEARCH.id\n  `,oe=e=>`\n    SELECT\n      id,\n      SUM(precision) as precision,\n      title,\n      album\n      year\n    FROM (\n      SELECT\n        OCC.songid as id,\n        OCC.precision,\n        OCC.title,\n        OCC.album,\n        OCC.year\n      FROM (SELECT \n    SEARCH.songid AS songid,\n    COUNT(SEARCH.songid) as precision,\n    SEARCH.title,\n    SEARCH.album,\n    SEARCH.year\n    FROM (${l().map(e,(e=>`SELECT \n      S.id AS songid, \n      S.title,\n      S.album,\n      S.year\n    FROM Songs S\n    WHERE \n      ${ae(e)}\n    `)).join(" UNION ALL ")}) SEARCH\n    GROUP BY songid) OCC\n      \n      UNION ALL\n\n      SELECT\n        S.id AS id,\n        A.precision as precision,\n        S.title AS title,\n        S.album AS album,\n        S.year AS year\n      FROM Songs S, SongArtists SA, (${ne(e)}) A\n      WHERE SA.artist_id = A.id\n      AND SA.song_id = S.id\n      \n      UNION ALL\n\n      SELECT\n        S.id AS id,\n        G.precision as precision,\n        S.title AS title,\n        S.album AS album,\n        S.year AS year\n      FROM Songs S, SongGenres SG, (${ie(e)}) G\n      WHERE SG.genre_id = G.id\n      AND SG.song_id = S.id\n    ) GROUP BY id`,ae=e=>{const t=re(e),s=de(e),n=le(e);let i="";return t.length>0&&(i+=(i.length>0?" OR ":"")+`(${t})`),s.length>0&&(i+=(i.length>0?" OR ":"")+`(${s})`),n.length>0&&(i+=(i.length>0?" OR ":"")+`(${n})`),i},re=e=>`S.title LIKE '%${e}%'`.trim(),de=e=>`S.album LIKE '%${e}%'`.trim(),le=e=>{const t=parseInt(e);return(l().isNaN(t)?"":`S.year = ${t}`).trim()},ue=se,ce=(e,t)=>o.default.PlaylistSongs.create(e,{transaction:t}),pe=(e,t)=>o.default.PlaylistSongs.destroy({where:e,transaction:t}),ge=i().Router();ge.post("/api/playlists",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),o.default.Playlist.findAll({include:[{model:o.default.User,attributes:["id","name"],as:"User"},{model:o.default.Song,attributes:["id"],as:"Songs",through:{attributes:["index"]}}],order:[[a.Sequelize.fn("lower",a.Sequelize.col("Playlist.name")),"ASC"]],where:{userid:e.body.userid}}).then((e=>t.send(e))).catch((e=>(console.log("There was an error querying playlists",JSON.stringify(e)),t.status(500).send(e))))})),ge.get("/api/playlist/:id",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.params.id;o.default.Playlist.findOne({where:{id:s},include:[{model:o.default.User,attributes:["id","name"],as:"User"},{model:o.default.Song,as:"Songs",through:{attributes:["index"]},include:[{model:o.default.Genre,as:"Genres",through:{attributes:[]}},{model:o.default.Artist,as:"Artists",through:{attributes:[]}}],order:[["index","asc"]]}]}).then((e=>t.send(Se(e)))).catch((e=>(console.log(`There was an error querying playlist ${s}`,JSON.stringify(e)),t.status(500).send(e))))})),ge.put("/api/playlist",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body;var n;(n=s,n.id>0?o.default.Playlist.update(n,{where:{id:n.id}}):o.default.Playlist.create(n)).then((e=>{t.status(200).send({success:!0,object:Se(e)})})).catch((e=>{t.status(200).send({success:!1,object:s,errors:(0,o.formatSequelizeErrors)(e.errors)})}))})),ge.delete("/api/playlist",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s={id:e.body.id};(e=>o.default.Playlist.destroy({where:e}))(s).then((()=>t.send(s))).catch((e=>(console.log("There was an error deleting playlist",JSON.stringify(e)),t.status(500).send(e))))}));const Se=e=>({id:e.id,name:e.name,userid:e.userid,public:e.public,OrderedSongs:l().map(e.Songs,(e=>({index:e.PlaylistSongs.index,song:F(e)}))),createdAt:e.createdAt,updatedAt:e.updatedAt});ge.put("/api/playlistsong",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body;return o.default.DB.transaction((async e=>o.default.PlaylistSongs.findOne({where:{playlistid:s.playlistid},attributes:[[r().fn("COUNT",r().col("songid")),"nbsongs"]],transaction:e,raw:!0}).then((t=>ce({...s,index:t.nbsongs},e))).then((e=>{t.status(200).send({success:!0,object:ye(e)})})).catch((e=>{t.status(200).send({success:!1,object:s,errors:l().map(e.errors,(e=>({path:e.path,key:e.validatorKey,message:e.message})))})}))))})),ge.put("/api/playlistsongorder",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body,n=s.playlistid,i=s.songsorder;return o.default.DB.transaction((async e=>pe({playlistid:n},e).then((()=>{const t=l().map(i,(t=>{const s={...t,playlistid:n};return ce(s,e)}));return Promise.all(t)})).then((e=>{t.status(200).send({success:!0,object:l().map(e,ye)})})).catch((e=>{t.status(200).send({success:!1,object:s,errors:l().map(e.errors,(e=>({path:e.path,key:e.validatorKey,message:e.message})))})}))))})),ge.delete("/api/playlistsong",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body;return o.default.DB.transaction((async e=>{pe(s,e).then((()=>{t.status(200).send({success:!0,object:ye(s)})})).catch((e=>{t.status(200).send({success:!1,object:s,errors:(0,o.formatSequelizeErrors)(e.errors)})}))}))}));const ye=e=>({id:e.id,playlistid:e.playlistid,songid:e.songid,createdAt:e.createdAt,updatedAt:e.updatedAt}),he=ge,me=i().Router();me.put("/api/favoritesong",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body;return o.default.DB.transaction((async e=>{return t={songid:s.songid,userid:s.userid},n=e,o.default.Favorite.create(t,{transaction:n});var t,n})).then((e=>{t.status(200).send({success:!0,object:e})})).catch((e=>{t.status(200).send({success:!1,object:s,errors:l().map(e.errors,(e=>({path:e.path,key:e.validatorKey,message:e.message})))})}))})),me.delete("/api/favoritesong",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body;return o.default.DB.transaction((async e=>{var n,i;(n=s,i=e,o.default.Favorite.destroy({where:n,transaction:i})).then((()=>{t.status(200).send({success:!0,object:fe(s)})})).catch((e=>{t.status(200).send({success:!1,object:s,errors:(0,o.formatSequelizeErrors)(e.errors)})}))}))}));const fe=e=>({id:e.id,songid:e.songid,userid:e.userid,createdAt:e.createdAt,updatedAt:e.updatedAt}),Ae=me,Te=i().Router();Te.post("/api/year",((e,t)=>{var s=e.body.song.year;t.header("Content-Type","application/json; charset=utf-8"),o.default.Song.findAll({attributes:["id","filepath","filename","title","album","year","duration"],where:{year:s},include:[{model:o.default.Artist,as:"Artists",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:o.default.Genre,as:"Genres",attributes:["id","name"],required:!1,through:{attributes:[]}}]}).then((e=>t.send(e))).catch((e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e))))}));const Ee=Te,Ne=i().Router();Ne.post("/api/quiz/concurrents",((e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const s=e.body.current,n=e.body.limit;Promise.all([o.default.DB.query(y({sortKey:"artistrelated",activeSong:s,excludesongids:[s.id]},!1),{type:r().QueryTypes.SELECT}),o.default.DB.query(y({sortKey:"lastadded",artistids:l().map(s?.Artists,"id"),excludesongids:[s.id]},!1),{type:r().QueryTypes.SELECT}),o.default.DB.query(y({sortKey:"samegenre",genreids:l().map(s?.Genres,"id"),excludesongids:[s.id]},!1),{type:r().QueryTypes.SELECT}),o.default.DB.query(y({sortKey:"shuffle",excludesongids:[s.id],limit:n},!1),{type:r().QueryTypes.SELECT})]).then((([e,t,n,i])=>{const o=[...l().uniqBy([...l().map(e,(e=>({priority:3,song:e}))),...l().map(t,(e=>({priority:2,song:e}))),...l().map(n,(e=>({priority:1,song:e})))],(e=>e.song.id)),...l().map(i,(e=>({priority:0,song:e})))];if(console.log(`RELATED (${e.length}), SAME ARTIST (${t.length}), GENRES (${n.length}), SHUFFLE (${i.length})`),o.length>0){const e=[s,...l().map(o.slice(0,3),"song")];return Promise.all(l().map(e,(e=>B(e.id))))}return Promise.resolve})).then((e=>t.status(200).send({origin:"concurrents",songs:e}))).catch((e=>(console.log("There was an error querying concurrents"),t.status(500).send(e))))}));const be=Ne,_e=s(147),Ce=process.env.SERVERPORT||81;console.log("__________.__        .__         _____________________ ____________________"),console.log("\\______   \\__| _____ |__|__  ___ \\______   \\_   _____//   _____/\\__    ___/"),console.log(" |     ___/  |/     \\|  \\  \\/  /  |       _/|    __)_ \\_____  \\   |    |   "),console.log(" |    |   |  |  Y Y  \\  |>    <   |    |   \\|        \\/        \\  |    |   "),console.log(" |____|   |__|__|_|  /__/__/\\_ \\  |____|_  /_______  /_______  /  |____|   "),console.log("                   \\/         \\/         \\/        \\/        \\/            v"+_e.version),console.log();const Ge=s(986);var Oe=i()();Oe.use(((e,t,s)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),s()})),Oe.use(Ge.json()),Oe.use(i().static(t().join(__dirname,"/static"))),Oe.use(p),Oe.use(J),Oe.use(te),Oe.use(ue),Oe.use(H),Oe.use(Ee),Oe.use(v),Oe.use(j),Oe.use(he),Oe.use(Ae),Oe.use(be),Oe.listen(Ce,(()=>{console.log(`> API listening to ${Ce}....`),console.log("> REST API initialized")}))})()})();