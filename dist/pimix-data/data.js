!function(e){var t={};function n(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(s,o,function(t){return e[t]}.bind(null,o));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=35)}([function(e,t,n){"use strict";const s=n(2),o=n(6).production,i={};let r;r=o.use_env_variable?new s(process.env[o.use_env_variable],o):new s(o.database,o.username,o.password,o);const a=n(7);a.keys().map(a).forEach(e=>{const t=e(r,s);i[t.name]=t}),Object.keys(i).forEach(e=>{i[e].associate&&i[e].associate(i)}),i.sequelize=r,i.Sequelize=s,t.a=i},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("sequelize")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("jimp")},function(e,t){e.exports=require("path")},function(e){e.exports=JSON.parse('{"development":{"dialect":"sqlite","seederStorage":"sequelize","storage":"./pimix.sqlite3","logging":false},"production":{"dialect":"sqlite","storage":"/home/pimix.sqlite3","seederStorage":"sequelize","logging":false}}')},function(e,t,n){var s={"./artist.js":8,"./genre.js":9,"./song.js":10,"./songartist.js":11,"./songgenre.js":12,"./songlog.js":13,"./songloguser.js":14,"./user.js":15};function o(e){var t=i(e);return n(t)}function i(e){if(!n.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}o.keys=function(){return Object.keys(s)},o.resolve=i,e.exports=o,o.id=7},function(e,t,n){"use strict";e.exports=(e,t)=>e.define("Artist",{name:t.STRING})},function(e,t,n){"use strict";e.exports=(e,t)=>e.define("Genre",{name:t.STRING})},function(e,t,n){"use strict";e.exports=(e,t)=>{const n=e.define("Song",{filepath:t.STRING,filename:t.STRING,title:t.STRING,album:t.STRING,year:t.INTEGER,bitrate:t.INTEGER,duration:t.DOUBLE,samplerate:t.INTEGER,size:t.INTEGER,ino:t.INTEGER,birth:t.DATE},{indexes:[{unique:!0,fields:["filepath","filename"]}]});return n.beforeValidate(e=>{e.filepath&&(e.filepath=e.filepath.replace(/\\/g,"/"))}),n.associate=function(e){e.Song.hasMany(e.SongLog,{as:"SongLogs",foreignKey:"songid"})},n}},function(e,t,n){"use strict";e.exports=(e,t)=>{const n=e.define("SongArtist",{song_id:t.INTEGER,artist_id:t.INTEGER},{indexes:[{unique:!0,fields:["song_id","artist_id"]}]});return n.associate=function(e){e.Song.belongsToMany(e.Artist,{as:"Artists",through:{model:n,unique:!1},foreignKey:"song_id"}),e.Artist.belongsToMany(e.Song,{as:"Songs",through:{model:n,unique:!1},foreignKey:"artist_id"})},n}},function(e,t,n){"use strict";e.exports=(e,t)=>{const n=e.define("SongGenre",{song_id:t.INTEGER,genre_id:t.INTEGER},{indexes:[{unique:!0,fields:["song_id","genre_id"]}]});return n.associate=function(e){e.Song.belongsToMany(e.Genre,{as:"Genres",through:{model:n,unique:!1},foreignKey:"song_id"}),e.Genre.belongsToMany(e.Song,{as:"Songs",through:{model:n,unique:!1},foreignKey:"genre_id"})},n}},function(e,t,n){"use strict";e.exports=(e,t)=>{const n=e.define("SongLog",{sessionid:t.STRING(36),songid:t.INTEGER,listenratio:t.FLOAT,origin:t.STRING(10)});return n.associate=function(e){n.belongsTo(e.Song,{foreignKey:"songid"})},n}},function(e,t,n){"use strict";e.exports=(e,t)=>{const n=e.define("SongLogUser",{logid:t.INTEGER,userid:t.INTEGER,vote:t.INTEGER});return n.associate=function(e){n.belongsTo(e.SongLog,{foreignKey:"logid"}),n.belongsTo(e.User,{foreignKey:"userid"})},n}},function(e,t,n){"use strict";var s=n(16);e.exports=(e,t)=>{const n=e.define("User",{login:t.STRING,password:t.STRING,name:t.STRING,rights:t.INTEGER});return n.prototype.validPassword=function(e){return s.compareSync(e,this.password)},n.beforeCreate(e=>(void 0!==e.login&&(e.login=e.login.trim()),void 0!==e.name&&(e.name=e.name.trim()),e)),n.afterValidate(e=>{void 0!==e.password&&(e.password=s.hashSync(e.password,s.genSaltSync(10),null))}),n}},function(e,t){e.exports=require("bcryptjs")},function(e){e.exports=JSON.parse('{"name":"pimix-data","version":"1.0.8","description":"Pimix REST API from data management","main":"index.js","scripts":{"scanner":"nodemon ./dist/scanner.js","data":"nodemon ./dist/data.js","test":"echo \\"Error: no test specified\\" && exit 1","lint":"eslint \\"src/**/*.js\\" --ignore-pattern node_modules/ ","build":"rm -rf dist && webpack","start":"npx concurrently -k -n \\"data,scanner\\" -p \\"[{name}]\\" -c \\"yellow,green\\" \\"npm run data\\" \\"npm run scanner\\""},"repository":{"type":"git","url":"git+https://github.com/vbarrois/pimix-data.git"},"author":"Vincent Barrois","license":"ISC","bugs":{"url":"https://github.com/vbarrois/pimix-data/issues"},"homepage":"https://github.com/vbarrois/pimix-data#readme","dependencies":{"@babel/core":"^7.9.6","@babel/preset-env":"^7.9.6","babel-loader":"^8.1.0","copy-webpack-plugin":"^5.1.1","eslint":"^6.6.0","eslint-config-standard":"^14.1.0","eslint-loader":"^4.0.2","eslint-plugin-import":"^2.18.2","eslint-plugin-node":"^10.0.0","eslint-plugin-promise":"^4.2.1","eslint-plugin-standard":"^4.0.1","nodemon":"^1.19.4","webpack":"^4.43.0","webpack-cli":"^3.3.11","webpack-dev-middleware":"^3.7.2","webpack-hot-middleware":"^2.25.0","webpack-node-externals":"^1.7.2","bcryptjs":"^2.4.3","bull":"^3.11.0","chokidar":"^3.2.2","colors":"^1.4.0","concurrently":"^5.1.0","express":"^4.17.1","jimp":"^0.10.0","moment":"^2.24.0","music-metadata":"^4.8.2","node-spotify-api":"^1.1.1","sequelize":"^5.21.1","socket.io":"^2.3.0","sqlite3":"^4.1.1"}}')},,,,,,,function(e,t,n){"use strict";n.r(t),n.d(t,"addSongLog",(function(){return o})),n.d(t,"updateSongLog",(function(){return i})),n.d(t,"addSongUserLog",(function(){return r}));var s=n(0);const o=e=>s.a.SongLog.create(e),i=e=>s.a.SongLog.update({listenratio:e.listenratio},{where:{id:e.id}}),r=e=>s.a.SongLogUser.create(e)},function(e,t){e.exports=require("body-parser")},,,,,,,,,,function(e,t,n){"use strict";n.r(t);var s=n(5),o=n.n(s),i=n(1),r=n.n(i),a=n(0);const d=r.a.Router();d.post("/api/login",(e,t)=>{a.a.User.findOne({where:{login:e.body.login}}).then(n=>n?n.validPassword(e.body.password)?t.status(200).send({connected:!0,user:n}):t.status(200).send({connected:!1,message:"Incorrect password."}):t.status(200).send({connected:!1,message:"Incorrect login."}))}),d.post("/api/pseudo",(e,t)=>{a.a.User.findOrCreate({where:{login:e.body.login},defaults:{login:e.body.login,name:e.body.login,rights:0}}).then(e=>{const n=e[0].dataValues;return n?t.status(200).send({connected:!0,user:n}):t.status(200).send({connected:!1,message:"Incorrect pseudo."})})});var u=d,g=n(2),l=n.n(g);const c=r.a.Router();function S(e){return new Promise((t,n)=>{const s="SELECT S.id AS id, S.filename AS filename FROM Songs S, SongGenres SG, Genres G WHERE SG.song_id = S.id AND SG.genre_id = G.id AND G.state = 1 "+(void 0!==e?"AND S.id <> "+e.id+" ":"")+"ORDER BY RANDOM() LIMIT 0, 1";a.a.sequelize.query(s,{type:l.a.QueryTypes.SELECT}).then(e=>{if(console.log("NEXT (Shuffle but not played yet) : "),console.log(e),e.length>0){return p(e[0].id)}}).then(t).catch(n)})}function p(e){return a.a.Song.findOne({where:{id:e},attributes:["id","filepath","filename","title","album","year","duration"],include:[{model:a.a.Artist,as:"Artists",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:a.a.Genre,as:"Genres",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:a.a.SongLog,as:"SongLogs",attributes:["listenratio"]}]})}c.post("/api/genius/next",(e,t)=>{var n;t.header("Content-Type","application/json; charset=utf-8"),e.body.shuffle?S(e.body.current).then(e=>t.status(200).send({origin:"shuffle",song:e})).catch(e=>(console.log("There was an error querying genius next",JSON.stringify(e)),t.status(500).send(e))):(n=e.body.current,new Promise((e,t)=>{const s="SELECT S.id AS id, S.filename AS filename, count() AS played, "+(void 0!==n?"ABS(S.year-"+n.year+") AS yeardelta, ":"")+"(AVG(SL.listenratio)*2-.4)*(1-1.0/(count(SL.listenratio)+2)) AS avgduration FROM Songs S,SongLogs SL, SongGenres SG, Genres G WHERE S.id = SL.songid AND SG.song_id = S.id AND SG.genre_id = G.id AND G.state = 1 "+(void 0!==n?"AND S.id <> "+n.id+" ":"")+'AND S.id NOT IN (SELECT SGLG.songid from SongLogs SGLG where datetime(SGLG.createdAt) >= datetime("now", "-2 Hour")) GROUP BY S.id ORDER BY avgduration DESC, '+(void 0!==n?"yeardelta ASC, ":"")+"S.id DESC LIMIT 0, 1";a.a.sequelize.query(s,{type:l.a.QueryTypes.SELECT}).then(e=>(console.log("NEXT (Genius) : "),console.log(e),e.length>0?p(e[0].id):S())).then(e).catch(t)})).then(e=>t.status(200).send({origin:"genius",song:e})).catch(e=>(console.log("There was an error querying genius next",JSON.stringify(e)),t.status(500).send(e)))});var h=c,y=n(3),f=n.n(y);const _=n(24),m=r.a.Router();m.post("/api/log/songplayed",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const n=e.body.item,s=e.body.sessionid,o=e.body.item.origin;null!==n&&null!==n.song&&_.addSongLog({sessionid:s,songid:n.song.id,origin:o}).then(e=>{const t=e.dataValues,s=[];return f.a.forEach(n.votes,e=>{const n={logid:t.id,userid:e.id,vote:e.points};s.push(_.addSongUserLog(n))}),new Promise((e,n)=>{Promise.all(s).then(e(t)).catch(n)})}).then(e=>t.status(200).send(e)).catch(e=>(console.log("Cannot create song logs",JSON.stringify(e)),t.status(500).send(e)))}),m.post("/api/log/songcomplete",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const n=e.body.id,s=e.body.listenratio;_.updateSongLog({id:n,listenratio:s}).then(()=>t.status(200).end()).catch(e=>(console.log("Cannot update song logs",JSON.stringify(e)),t.status(500).send(e)))});var E=m;const A=r.a.Router(),b=l.a.Op,T={attributes:["id","filepath","filename","title","album","year","duration","birth"],include:[{model:a.a.Artist,as:"Artists",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:a.a.Genre,as:"Genres",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:a.a.SongLog,as:"SongLogs",attributes:["listenratio"]}]};A.post("/api/search/library",(e,t)=>{var n=e.body.keywords;t.header("Content-Type","application/json; charset=utf-8"),a.a.Song.findAll({attributes:["id","filepath","filename","title","album","year","duration"],where:{[b.or]:[{title:{[b.like]:"%"+n+"%"}},{filename:{[b.like]:"%"+n+"%"}},{year:n},{"$Genres.name$":{[b.like]:"%"+n+"%"}},{"$Artists.name$":{[b.like]:"%"+n+"%"}}]},include:[{model:a.a.Artist,as:"Artists",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:a.a.Genre,as:"Genres",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:a.a.SongLog,as:"SongLogs",attributes:["listenratio"]}]}).then(e=>t.send(e)).catch(e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e)))}),A.post("/api/search/:mode",(e,t)=>{const n=e.body.current,s=void 0!==n?n.year:0,o=void 0!==n?n.id:0,i=e.body.sessionid;var r;switch(e.params.mode){case"listenratio":r="SELECT SL.songid AS id, AVG(SL.listenratio) AS listenratio, COUNT(SL.songid) AS played FROM SongLogs SL GROUP BY SL.songid ORDER BY listenratio desc, played DESC";break;case"mostplayed":r="SELECT SL.songid AS id, COUNT(SL.songid) AS played FROM SongLogs SL GROUP BY SL.songid ORDER BY played DESC, SL.createdAt DESC";break;case"mostvoted":r="SELECT SL.songid AS id, SUM(SLU.vote) AS vote FROM SongLogUsers SLU, SongLogs SL WHERE SLU.logid = SL.id GROUP BY SL.songid ORDER BY vote DESC, SL.createdAt DESC";break;case"lastadded":r="SELECT S.id AS id, S.birth AS birth FROM Songs S ORDER BY birth DESC, S.id DESC";break;case"sameartist":r="SELECT SA.song_id AS id, SA.artist_id AS artistid, ABS(S.year-"+s+") AS decay FROM SongArtists SA, Songs S WHERE S.id = SA.song_id AND S.id <> "+o+" AND SA.artist_id in ("+f.a.map(n.Artists,e=>e.id).toString()+") ORDER BY decay ASC, artistid ASC, SA.song_id DESC";break;case"samegenre":r="SELECT SG.song_id AS id, SG.genre_id AS genreid, ABS(S.year-"+s+") AS decay FROM SongGenres SG, Songs S WHERE S.id = SG.song_id AND S.id <> "+o+" AND SG.genre_id in ("+f.a.map(n.Genres,e=>e.id).toString()+") ORDER BY decay ASC, genreid ASC, SG.song_id DESC";break;case"sameyear":r="SELECT S.id AS id FROM Songs S WHERE S.year = "+s+" AND S.id <> "+o+" ORDER BY S.id DESC";break;case"never":r="SELECT S.id AS id, ABS(S.year-"+s+") AS yeardelta FROM Songs S WHERE S.id NOT IN ( SELECT songid FROM SongLogs) ORDER BY yeardelta ASC, S.id DESC";break;case"genius":r="SELECT S.id AS id, count() AS played, ABS(S.year-"+s+") AS yeardelta, (AVG(SL.listenratio)*2-.4)*(1-1.0/(count(SL.listenratio)+2)) AS avgduration FROM Songs S, SongLogs SL WHERE S.id = SL.songid AND S.id <> "+o+" AND S.id NOT IN ( SELECT songid FROM SongLogs WHERE sessionid = '"+i+"') GROUP BY S.id ORDER BY avgduration DESC, yeardelta ASC, S.id DESC"}(function(e,t){return new Promise((e,n)=>{const s=t+" LIMIT 0, 100";a.a.sequelize.query(s,{type:l.a.QueryTypes.SELECT}).then(e=>function(e){return new Promise((t,n)=>{const s=f.a.map(e,e=>e.id);var o=T;o.where={id:{[b.in]:s}},a.a.Song.findAll(o).then(n=>{const s=f.a.map(e,e=>f.a.merge(e,f.a.find(f.a.map(n,e=>e.get({plain:!0})),t=>t.id===e.id)));t(s)}).catch(n)})}(e)).then(t=>{e(t)}).catch(n)})})(0,r).then(e=>{t.send(e)}).catch(e=>(console.log("There was an error querying mostvoted",JSON.stringify(e)),t.status(500).send(e)))});var G=A,R=n(4),L=n.n(R);const O=r.a.Router(),C=process.env.COVER_FOLDER||"/home/covers";function N(e,t){return new Promise((n,s)=>{a.a.Song.findOne({where:{id:e}}).then(e=>{const i=C+(t?"/thumbs/":"/")+o.a.parse(e.filename).name+".jpg";L.a.read(i).then(e=>{e.getBuffer(L.a.MIME_JPEG,(e,t)=>{e?s(e):n(t)})}).catch(e=>{s(e)})}).catch(e=>{s(e)})})}O.get("/api/songs",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),a.a.Song.findAll({include:[{model:a.a.Genre,as:"Genres"},{model:a.a.Artist,as:"Artists"}]}).then(e=>t.send(e)).catch(e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e)))}),O.get("/api/songs/genre/:genre",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),a.a.Song.findAll({where:{"$Genres.id$":e.params.genre.split(",")},include:[{model:a.a.Genre,as:"Genres",required:!1},{model:a.a.Artist,as:"Artists",required:!1}]}).then(e=>t.send(e)).catch(e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e)))}),O.get("/api/songs/artist/:artist",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8"),a.a.Song.findAll({where:{"$Artists.id$":e.params.artist.split(",")},include:[{model:a.a.Genre,as:"Genres",required:!1},{model:a.a.Artist,as:"Artists",required:!1}]}).then(e=>t.send(e)).catch(e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e)))}),O.get("/api/song/thumb/:id",(e,t)=>{N(e.params.id,!0).then(e=>{t.set("Content-Type",L.a.MIME_JPEG),t.status(200).send(e)}).catch(e=>{console.log(e),t.status(404).end()})}),O.get("/api/song/cover/:id",(e,t)=>{N(e.params.id,!1).then(e=>{t.set("Content-Type",L.a.MIME_JPEG),t.status(200).send(e)}).catch(()=>{t.status(404).end()})});var v=O;const q=r.a.Router();q.get("/api/genres",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8");a.a.sequelize.query("SELECT G.id, G.name, G.state, COUNT(SG.song_id) AS songs, MIN(S.year) AS yearfrom, MAX(S.year) AS yearto FROM SongGenres SG, Genres G, Songs S WHERE SG.genre_id = G.id AND SG.song_id = S.id GROUP BY G.id",{type:l.a.QueryTypes.SELECT}).then(e=>{t.status(200).json(e)}).catch(e=>{t.status(500).send(e)})}),q.post("/api/genres/state",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const n=e.body.genreid,s="UPDATE Genres SET state = "+e.body.state+" WHERE id = "+n;a.a.sequelize.query(s,{type:l.a.QueryTypes.UPDATE}).then(()=>{t.status(200).end()}).catch(e=>{t.status(500).send(e)})});var w=q;const D=r.a.Router();D.get("/api/artists",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8");a.a.sequelize.query("SELECT A.id, A.name, COUNT(SA.song_id) AS songs, MIN(S.year) AS yearfrom, MAX(S.year) AS yearto FROM SongArtists SA, Artists A, Songs S WHERE SA.artist_id = A.id AND SA.song_id = S.id GROUP BY A.id",{type:l.a.QueryTypes.SELECT}).then(e=>{t.status(200).json(e)}).catch(e=>{t.status(500).send(e)})}),D.post("/api/artists/state",(e,t)=>{t.header("Content-Type","application/json; charset=utf-8");const n=e.body.genreid,s="UPDATE Genres SET state = "+e.body.state+" WHERE id = "+n;a.a.sequelize.query(s,{type:l.a.QueryTypes.UPDATE}).then(()=>{t.status(200).end()}).catch(e=>{t.status(500).send(e)})});var I=D;const j=r.a.Router();j.post("/api/year",(e,t)=>{var n=e.body.song.year;t.header("Content-Type","application/json; charset=utf-8"),a.a.Song.findAll({attributes:["id","filepath","filename","title","album","year","duration"],where:{year:n},include:[{model:a.a.Artist,as:"Artists",attributes:["id","name"],required:!1,through:{attributes:[]}},{model:a.a.Genre,as:"Genres",attributes:["id","name"],required:!1,through:{attributes:[]}}]}).then(e=>t.send(e)).catch(e=>(console.log("There was an error querying songs",JSON.stringify(e)),t.status(500).send(e)))});var x=j;const M=n(17);console.clear(),console.log("__________.__   _____  .__         ________          __          "),console.log("\\______   \\__| /     \\ |__|__  ___ \\______ \\ _____ _/  |______   "),console.log(" |     ___/  |/  \\ /  \\|  \\  \\/  /  |    |  \\\\__  \\\\   __\\__  \\  "),console.log(" |    |   |  /    Y    \\  |>    <   |    `   \\/ __ \\|  |  / __ \\_"),console.log(" |____|   |__\\____|__  /__/__/\\_ \\ /_______  (____  /__| (____  /"),console.log("                     \\/         \\/         \\/     \\/          \\/ v"+M.version),console.log("                 is listening on http port 81"),console.log();const P=n(25);var U=r()();U.use((e,t,n)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n()}),U.use(P.json()),U.use(r.a.static(o.a.join(__dirname,"/static"))),U.use(u),U.use(h),U.use(E),U.use(G),U.use(v),U.use(x),U.use(w),U.use(I),U.listen(81,()=>{console.log("> REST API initialized")})}]);